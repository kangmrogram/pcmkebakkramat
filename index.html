<script>
  // ================= KONFIGURASI BARU (MULTI LOKASI) =================
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvGV3ArHE6GrxG33McPhXR5ZD0fBGaIJ--xOKJhqdW69-OVqq8RIPWkuQ0Vc_1V-kvpQ/exec"; 
  const MAX_RADIUS = 500; 

  // Daftar Koordinat (Sama dengan di Server)
  const DAFTAR_LOKASI = [
    { nama: "Masjid Abdul Aziz (SMPM 8)", lat: -7.520470615403366, lng: 110.9065007512984 },
    { nama: "Gedung Dakwah PDM", lat: -7.586223863399417, lng: 110.91830297060768 },
    { nama: "Masjid Al Mukarromah", lat: -7.5991158597467505, lng: 110.95277542273423 },
    { nama: "SMP Muhammadiyah 2 Kra", lat: -7.59240065605104, lng: 110.95609234835774 },
    { nama: "Masjid Raya Al Falah Sragen", lat: -7.42851997638584, lng: 111.01776973992412 },
    { nama: "Kantor Desa Ngadiluwih", lat: -7.633272545502858, lng: 110.99996825526591 },
    { nama: "Lokasi Testing", lat: -7.716564379562363, lng: 110.59027731779902 }
  ];

  var video = document.getElementById('camera');
  var latUser = 0, lngUser = 0, lokasiString = "", jarakUser = 0;
  var namaLokasiTerdekat = ""; // Variabel baru untuk nyimpan nama lokasi
  var namaKegiatan = "", isTimeOpen = false, isLocationOk = false, myModal;

  window.onload = function() {
    try {
      myModal = new bootstrap.Modal(document.getElementById('modalReport'));
      initClock(); 
      cekWaktuBuka();

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(s => video.srcObject = s).catch(e => alert("Kamera Error: " + e));

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(updatePosisi, e => {
           document.getElementById('statusLokasiBox').innerHTML = `<i class="bi bi-geo-alt"></i> GPS Error: ${e.message}`;
        }, { enableHighAccuracy: true });
      }

      loadOptions(); 
    } catch (e) { console.error(e); }
  };

  // ... (FUNGSI JAM DIGITAL & API LAINNYA TETAP SAMA) ...
  function initClock() {
    updateClock(); setInterval(updateClock, 1000); 
  }
  function updateClock() {
    var now = new Date();
    document.getElementById('clockTime').innerText = now.toLocaleTimeString('id-ID', { hour12: false }).replace(/\./g, ":");
    var dayName = now.toLocaleDateString('id-ID', { weekday: 'long' });
    if(dayName === 'Minggu') dayName = 'Ahad';
    document.getElementById('clockDay').innerText = dayName;
    var dateFull = now.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    document.getElementById('clockDate').innerText = dateFull;
    namaKegiatan = "Pengajian Ahad Pagi - " + dayName + ", " + dateFull;
  }
  
  async function loadOptions() {
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getOptions' }) });
      let res = await req.json();
      if(res.status === 'success') { isiDropdown('nama', res.nama); isiDropdown('aum', res.aum); }
    } catch (e) { console.log(e); }
  }

  // --- UPDATE: FUNGSI KIRIM ABSEN MENGGUNAKAN NAMA LOKASI ---
  async function kirimAbsen() {
    var nama = document.getElementById('nama').value;
    var aum = document.getElementById('aum').value;
    var kesimpulan = document.getElementById('kesimpulan').value;
    if (!nama || !aum || !kesimpulan) { alert("Harap lengkapi data!"); return; }
    document.getElementById('loading').classList.remove('hidden');

    var cvs = document.getElementById('canvas');
    cvs.width = video.videoWidth; cvs.height = video.videoHeight;
    var ctx = cvs.getContext('2d');
    ctx.save(); ctx.translate(cvs.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0); ctx.restore();
    
    // Watermark
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    ctx.fillRect(0, cvs.height - 80, cvs.width, 80);
    ctx.font = "bold 16px sans-serif"; ctx.fillStyle = "white"; 
    
    var infoLokasi = namaLokasiTerdekat ? namaLokasiTerdekat : "Lokasi Tidak Dikenal";
    
    ctx.fillText(document.getElementById('clockDay').innerText + ", " + document.getElementById('clockTime').innerText + " WIB", 20, cvs.height - 50);
    // Tampilkan Nama Lokasi di Foto
    ctx.fillText(infoLokasi + " ("+jarakUser+"m)", 20, cvs.height - 25);

    var base64 = cvs.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/, "");

    try {
      let req = await fetch(SCRIPT_URL, { 
        method: 'POST', body: JSON.stringify({ 
          action: 'savePresensi', 
          data: { nama: nama, aum: aum, kegiatan: namaKegiatan, kesimpulan: kesimpulan, lokasiString: lokasiString, lat: latUser, lng: lngUser, image: base64 } 
        }) 
      });
      let res = await req.json();
      document.getElementById('loading').classList.add('hidden');
      alert(res.message);
      if(res.status === 'success') location.reload();
    } catch (e) { 
        document.getElementById('loading').classList.add('hidden');
        alert("Gagal Kirim: " + e); 
    }
  }

  async function loadReportData() {
    var nama = document.getElementById('nama').value;
    if(!nama) return alert("Pilih Nama Dulu");
    document.getElementById('loadingReport').classList.remove('hidden');
    document.getElementById('contentReport').classList.add('hidden');
    try {
      let req = await fetch(SCRIPT_URL, { 
        method: 'POST', body: JSON.stringify({ action: 'getReport', nama: nama, start: document.getElementById('filterStart').value, end: document.getElementById('filterEnd').value }) 
      });
      let res = await req.json();
      document.getElementById('loadingReport').classList.add('hidden');
      document.getElementById('contentReport').classList.remove('hidden');
      document.getElementById('repNama').innerText = nama;
      document.getElementById('repAum').innerText = res.aum || "-";
      document.getElementById('repTotal').innerText = res.count + " / " + res.totalEvents;
      document.getElementById('repPercent').innerText = res.percent + "%";
      var img = document.getElementById('imgFotoTerbaru'), box = document.getElementById('boxFoto');
      if(res.fotoTerbaru) { img.src = "data:image/png;base64," + res.fotoTerbaru; box.classList.remove('hidden'); } else { box.classList.add('hidden'); }
      var tbody = document.getElementById('tabelHistory'); tbody.innerHTML = "";
      if(res.history.length === 0) tbody.innerHTML = "<tr><td colspan='2' class='text-center text-muted py-3'>Belum ada data</td></tr>";
      else res.history.forEach(i => tbody.innerHTML += `<tr><td class='text-start'><div class='fw-bold text-dark' style='font-size:0.8rem'>${i.tanggal.split('-')[0]}</div><div class='text-muted' style='font-size:0.7rem'>${i.tanggal.split('-')[1] || ''}</div></td><td class='text-end'><i class="bi bi-check-circle-fill text-success"></i></td></tr>`);
    } catch (e) { alert("Error Report: " + e); }
  }

  function isiDropdown(id, list) {
    var sel = document.getElementById(id);
    sel.innerHTML = `<option disabled selected>-- Pilih ${id === 'nama' ? 'Nama' : 'AUM'} --</option>`;
    list.forEach(i => { var o = document.createElement("option"); o.text = i; o.value = i; sel.add(o); });
  }
  function bukaModalReport() { myModal.show(); loadReportData(); }

  // --- FUNGSI GPS LOGIC MULTI LOKASI ---
  function updatePosisi(pos) {
    latUser = pos.coords.latitude; lngUser = pos.coords.longitude;
    lokasiString = latUser + "," + lngUser;
    
    // Loop cari jarak terdekat dari semua lokasi
    var jarakTerdekat = Infinity;
    var namaTerdekat = "";

    DAFTAR_LOKASI.forEach(loc => {
       var j = hitungJarak(latUser, lngUser, loc.lat, loc.lng);
       if (j < jarakTerdekat) {
          jarakTerdekat = j;
          namaTerdekat = loc.nama;
       }
    });

    jarakUser = Math.round(jarakTerdekat);
    namaLokasiTerdekat = namaTerdekat;

    var el = document.getElementById('statusLokasiBox');
    if (jarakUser <= MAX_RADIUS) { 
        isLocationOk = true; 
        el.className = 'status-pill status-ok'; 
        // Tampilkan Nama Lokasi yang terdeteksi
        el.innerHTML = `<i class="bi bi-geo-alt-fill text-success"></i> ${namaTerdekat} (${jarakUser}m)`; 
    } else { 
        isLocationOk = false; 
        el.className = 'status-pill status-err'; 
        el.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-danger"></i> Kejauhan (${jarakUser}m)`; 
    }
    cekTombol();
  }
  
  // Rumus Haversine (Hitung Jarak)
  function hitungJarak(lat1, lon1, lat2, lon2) {
    var R = 6371000, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function cekWaktuBuka() {
    var now = new Date(), day = now.getDay(), h = now.getHours(), m = now.getMinutes();
    var isOpen = (day === 0 && ((h === 6) || (h === 7 && m <= 30)));
    // isOpen = true; // TESTING
    var el = document.getElementById('statusWaktu');
    if(isOpen) { isTimeOpen = true; el.classList.add('hidden'); }
    else { isTimeOpen = false; el.classList.remove('hidden'); el.className = 'status-pill status-err'; el.innerHTML = "⛔ Presensi Ditutup"; }
    cekTombol();
  }

  function cekTombol() {
    var btn = document.getElementById('btnAbsen');
    if(isTimeOpen && isLocationOk) { btn.disabled = false; btn.innerHTML = `<i class="bi bi-send-fill me-2"></i> KIRIM PRESENSI`; }
    else { btn.disabled = true; btn.innerHTML = !isTimeOpen ? "⛔ WAKTU TUTUP" : "❌ LOKASI TIDAK SESUAI"; }
  }
</script>
