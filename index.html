<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Presensi Kajian AUM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    :root { --primary: #0f766e; --bg: #f8fafc; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; -webkit-tap-highlight-color: transparent;}
    .app-container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; overflow-x: hidden; }
    
    .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; display: flex; flex-direction: column; overflow-y: auto; }
    .overlay-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; background: white; position: sticky; top:0; z-index:10;}
    .overlay-body { padding: 20px; flex-grow: 1; }
    .btn-close-custom { background: none; border: none; font-size: 1.5rem; color: #334155; }
    .hidden { display: none !important; }

    #authScreen { z-index: 300; justify-content: center; position: relative; } 
    .auth-help-btn { position: absolute; top: 20px; right: 20px; background: #f1f5f9; color: var(--primary); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; z-index: 310; }
    .auth-logo { width: 90px; display: block; margin: 0 auto 15px; }
    .auth-title { text-align: center; font-weight: 800; color: var(--primary); margin-bottom: 5px; font-size: 1.4rem; line-height: 1.2; }
    .auth-subtitle { text-align: center; font-size: 0.9rem; color: #64748b; margin-bottom: 30px; font-weight: 500; }
    .toggle-link { text-align: center; margin-top: 15px; font-size: 0.85rem; color: #64748b; cursor: pointer; text-decoration: underline; }
    
    /* INPUTS STYLE */
    .input-box { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 14px; padding: 12px; margin-bottom: 15px; display: flex; align-items: center; }
    .input-box.error { border-color: #ef4444; background: #fef2f2; }
    .form-control-plain { border: none; background: transparent; width: 100%; outline: none; font-size: 0.95rem;}
    .form-label { font-size: 0.75rem; font-weight: 600; color: #64748b; display: block; margin-bottom: 4px; margin-left: 5px; }
    
    /* PASSWORD TOGGLE */
    .pass-toggle { color: #94a3b8; cursor: pointer; font-size: 1.2rem; margin-left: 8px; }
    .pass-toggle.active { color: var(--primary); }

    /* SEARCH FILTER */
    .filter-input { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.85rem; margin-bottom: 8px; }
    .error-text { color: #ef4444; font-size: 0.75rem; margin-top: -10px; margin-bottom: 10px; display: block; margin-left: 5px; font-weight: 500;}

    button.btn-primary { background: var(--primary); border: none; width: 100%; padding: 15px; border-radius: 15px; color: white; font-weight: 600; margin-top: 10px; }
    button.btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }

    /* DASHBOARD */
    .dashboard-header { background: linear-gradient(135deg, var(--primary), #0d9488); padding: 20px 20px 80px; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; color: white; position: relative; }
    .header-top { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 20px; padding-right: 90px; }
    .header-logo-img { width: 45px; height: 45px; border-radius: 10px; background: rgba(255,255,255,0.2); padding: 5px; backdrop-filter: blur(5px); }
    .header-title h1 { font-size: 1.1rem; font-weight: 800; margin: 0; line-height: 1.2; letter-spacing: 0.5px; }
    .header-title p { font-size: 0.75rem; margin: 0; opacity: 0.85; font-weight: 400; }
    .header-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; }
    .btn-action-glass { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); font-size: 0.9rem; transition: 0.2s; }
    .btn-action-glass:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
    .user-info-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 16px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
    .u-text h5 { margin: 0; font-size: 0.95rem; font-weight: 600; }
    .u-text p { margin: 0; font-size: 0.75rem; opacity: 0.8; }
    .btn-detail-profile { background: white; color: var(--primary); border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    .main-card { background: white; margin: -60px 20px 20px; border-radius: 24px; padding: 15px; box-shadow: 0 15px 30px rgba(0,0,0,0.08); position: relative; z-index: 10; }
    .photo-display { width: 100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 16px; background: #f1f5f9; margin-bottom: 15px; display: block; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .photo-loading { display: flex; align-items: center; justify-content: center; background: #e2e8f0; color: #64748b; font-size: 0.9rem; font-weight: 500; height: 200px; border-radius: 16px; margin-bottom: 15px;}
    .last-date-info { text-align: center; margin-bottom: 15px; }
    .last-date-info small { color: #64748b; font-size: 0.75rem; display: block; }
    .last-date-info strong { color: var(--primary); font-size: 0.9rem; }
    .stats-grid { display: flex; gap: 10px; margin-bottom: 20px; }
    .stat-item { flex: 1; background: #f8fafc; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
    .stat-value { font-weight: 700; font-size: 1.1rem; color: #334155; }
    .stat-value.highlight { color: var(--primary); }

    .action-area { padding: 0 20px 20px; }
    #btnStartAbsen { width: 100%; padding: 16px; font-size: 1rem; border-radius: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 8px 20px rgba(15, 118, 110, 0.2); transition: 0.3s; }
    #dashboardMsg { text-align: center; font-size: 0.8rem; margin-top: 10px; padding: 10px; border-radius: 10px; background: #fff3cd; color: #856404; display: none; border: 1px solid #ffeeba; }
    .msg-danger { background: #fee2e2 !important; color: #991b1b !important; border-color: #fca5a5 !important; }

    .history-section { padding: 0 20px 80px; }
    .history-item { background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .hist-date { font-weight: 600; font-size: 0.85rem; color: #334155; margin-bottom: 3px; }
    .hist-loc { font-size: 0.75rem; color: #64748b; display: flex; align-items: center; gap: 5px; }
    .hist-loc i { color: #dc2626; } 
    
    .camera-container { width: 100%; aspect-ratio: 1; background: black; position: relative; overflow: hidden; border-radius: 16px; }
    #camera { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    #infoModal { z-index: 400 !important; }
    .nav-tabs .nav-link { color: #64748b; font-size: 0.9rem; }
    .nav-tabs .nav-link.active { color: var(--primary); font-weight: 600; border-color: #dee2e6 #dee2e6 #fff; }
    .guide-step { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-start; }
    .step-num { background: #e0f2fe; color: var(--primary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; flex-shrink: 0; margin-top: 2px; }
    .step-text { font-size: 0.9rem; color: #334155; line-height: 1.5; }
    .browser-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; margin-bottom: 10px; display: inline-block; font-weight: 600;}
    .bg-chrome { background: #fef3c7; color: #b45309; } .bg-safari { background: #e0e7ff; color: #3730a3; } .bg-samsung { background: #fce7f3; color: #9d174d; }
  </style>
</head>
<body>

<div id="loading" class="hidden"><div class="spinner-border text-success"></div><p class="mt-2 fw-bold text-success small">Memproses...</p></div>

<div class="app-container">

  <div id="authScreen" class="fullscreen-overlay">
    <div style="padding: 30px; display: flex; flex-direction: column; justify-content: center; height: 100%;">
        
        <button class="auth-help-btn" onclick="openInfoModal()" title="Panduan & Instalasi"><i class="bi bi-question-lg"></i></button>

        <img src="https://www.freepnglogos.com/uploads/logo-muhammadiyah-png/hq-free-logo-muhammadiyah-png-download-16.png" class="auth-logo">
        <h4 class="auth-title">Presensi Kajian AUM</h4>
        <p class="auth-subtitle">PCM Kebakkramat, Karanganyar</p>
        
        <div id="formLogin">
          <label class="form-label">Username</label>
          <div class="input-box">
             <input type="text" id="loginUser" class="form-control-plain" placeholder="Username / Email / No.HP" oninput="validateUsername(this)">
          </div>
          <span id="loginUserError" class="error-text hidden">Tidak boleh ada spasi!</span>

          <label class="form-label">Password</label>
          <div class="input-box">
             <input type="password" id="loginPass" class="form-control-plain" placeholder="Password">
             <i class="bi bi-eye-slash pass-toggle" onclick="togglePassword('loginPass', this)"></i>
          </div>
          <button class="btn-primary" onclick="doLogin()">MASUK</button>
          <div class="toggle-link" onclick="showRegister()">Klaim Nama / Daftar Akun</div>
        </div>

        <div id="formRegister" class="hidden">
          <div class="alert alert-info py-2 small">Pilih Nama & AUM untuk membuat akun.</div>
          
          <label class="form-label">Nama Lengkap</label>
          <input type="text" class="filter-input" placeholder="Cari nama..." onkeyup="filterOptions('regNama', this.value)">
          <div class="input-box"><select id="regNama" class="form-control-plain"><option disabled selected>-- Pilih Nama --</option></select></div>
          
          <label class="form-label">Asal AUM</label>
          <input type="text" class="filter-input" placeholder="Cari AUM..." onkeyup="filterOptions('regAum', this.value)">
          <div class="input-box"><select id="regAum" class="form-control-plain"><option disabled selected>-- Pilih AUM --</option></select></div>
          
          <label class="form-label">Username Baru</label>
          <div class="input-box">
             <input type="text" id="regUser" class="form-control-plain" placeholder="Buat Username" oninput="validateUsername(this)">
          </div>
          <span id="regUserError" class="error-text hidden">Tidak boleh ada spasi!</span>
          
          <label class="form-label">Password Baru</label>
          <div class="input-box">
             <input type="password" id="regPass" class="form-control-plain" placeholder="Buat Password">
             <i class="bi bi-eye-slash pass-toggle" onclick="togglePassword('regPass', this)"></i>
          </div>
          
          <button class="btn-primary" onclick="doRegister()">DAFTAR AKUN</button>
          <div class="toggle-link" onclick="showLogin()">Sudah punya akun? Login</div>
        </div>
    </div>
  </div>

  <div id="homeScreen" class="hidden">
    <div class="dashboard-header">
      <div class="header-top">
        <img src="icon-512.png" class="header-logo-img" alt="Logo" onerror="this.src='https://www.freepnglogos.com/uploads/logo-muhammadiyah-png/hq-free-logo-muhammadiyah-png-download-16.png'">
        <div class="header-title"><h1>Presensi Kajian AUM</h1><p>PCM Kebakkramat, Karanganyar</p></div>
      </div>
      <div class="header-actions">
        <button class="btn-action-glass" onclick="openInfoModal()"><i class="bi bi-question-lg"></i></button>
        <button class="btn-action-glass" onclick="openChangePassword()"><i class="bi bi-key-fill"></i></button>
        <button class="btn-action-glass" onclick="doLogout()"><i class="bi bi-box-arrow-right"></i></button>
      </div>
      <div class="user-info-row">
        <div class="u-text"><h5 id="dashNama">Nama User</h5><p id="dashAum">Asal AUM</p></div>
        <button class="btn-detail-profile" onclick="openProfile()"><i class="bi bi-person-lines-fill"></i></button>
      </div>
    </div>

    <div class="main-card">
      <div id="photoContainer" class="photo-loading"><span><div class="spinner-border spinner-border-sm text-secondary me-2"></div> Memuat Foto...</span></div>
      <img id="dashFoto" class="photo-display hidden">
      <div class="text-center mb-3">
         <small class="text-muted">Terakhir Hadir:</small><br><strong id="dashLastDate" class="text-primary">-</strong>
      </div>
      <div class="stats-grid">
         <div class="stat-item"><small class="text-muted">KEHADIRAN</small><div id="statCount" class="stat-value">0 / 0</div></div>
         <div class="stat-item"><small class="text-muted">PERSENTASE</small><div id="statPercent" class="stat-value highlight">0%</div></div>
      </div>
    </div>

    <div class="action-area">
      <button id="btnStartAbsen" class="btn-primary" onclick="openPresensiMode()" disabled><div class="spinner-border spinner-border-sm"></div> Memuat...</button>
      <div id="dashboardMsg"></div>
    </div>

    <div class="history-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="fw-bold">Riwayat</span>
        <select id="limitSelect" class="form-select form-select-sm w-auto" onchange="loadDashboardData()"><option value="10">10</option><option value="25">25</option><option value="50">50</option></select>
      </div>
      <div id="historyList"><div class="text-center small text-muted">Memuat...</div></div>
    </div>
  </div>

  <div id="presensiScreen" class="fullscreen-overlay hidden">
    <div class="overlay-header"><h6 class="m-0 fw-bold">Form Presensi</h6><button class="btn-close-custom" onclick="closePresensiMode()"><i class="bi bi-x"></i></button></div>
    <div class="overlay-body">
        <div class="camera-container mb-3"><video id="camera" autoplay playsinline></video></div>
        <canvas id="canvas" class="hidden"></canvas>
        <div id="statusLokasiBox" class="alert alert-warning py-2 small mb-3">Mencari Lokasi...</div>
        <div class="input-box"><textarea id="kesimpulan" class="form-control-plain" rows="3" placeholder="Tulis kesimpulan kajian..."></textarea></div>
        <button id="btnKirim" class="btn-primary" onclick="kirimAbsen()" disabled>KIRIM DATA</button>
    </div>
  </div>

  <div id="profileScreen" class="fullscreen-overlay hidden">
    <div class="overlay-header"><h6 class="m-0 fw-bold">Profil Anggota</h6><button class="btn-close-custom" onclick="closeProfile()"><i class="bi bi-arrow-left"></i></button></div>
    <div class="overlay-body">
        <label class="form-label">Nama Lengkap</label><div class="input-box"><input type="text" id="profNama" class="form-control-plain"></div>
        <label class="form-label">Asal AUM</label><div class="input-box"><select id="profAum" class="form-control-plain"></select></div>
        <label class="form-label">Jenis Kelamin</label><div class="input-box"><select id="profJk" class="form-control-plain"><option value="">- Pilih -</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
        <label class="form-label">NBM</label><div class="input-box"><input type="text" id="profNbm" class="form-control-plain"></div>
        <label class="form-label">Tempat Lahir</label><div class="input-box"><input type="text" id="profTempat" class="form-control-plain"></div>
        <label class="form-label">Tanggal Lahir</label><div class="input-box"><input type="date" id="profTgl" class="form-control-plain"></div>
        <label class="form-label">Alamat</label><div class="input-box"><textarea id="profAlamat" class="form-control-plain" rows="2"></textarea></div>
        <label class="form-label">Email</label><div class="input-box"><input type="email" id="profEmail" class="form-control-plain"></div>
        <label class="form-label">No HP</label><div class="input-box"><input type="text" id="profHp" class="form-control-plain"></div>
        <button class="btn-primary" onclick="saveProfile()">SIMPAN PERUBAHAN</button>
    </div>
  </div>

  <div id="passwordScreen" class="fullscreen-overlay hidden">
    <div class="overlay-header"><h6 class="m-0 fw-bold">Ganti Password</h6><button class="btn-close-custom" onclick="closeChangePassword()"><i class="bi bi-x"></i></button></div>
    <div class="overlay-body">
        <div class="input-box"><input type="password" id="passNew" class="form-control-plain" placeholder="Password Baru"><i class="bi bi-eye-slash pass-toggle" onclick="togglePassword('passNew', this)"></i></div>
        <div class="input-box"><input type="password" id="passConfirm" class="form-control-plain" placeholder="Ulangi Password Baru"><i class="bi bi-eye-slash pass-toggle" onclick="togglePassword('passConfirm', this)"></i></div>
        <button class="btn-primary" onclick="savePassword()">UBAH PASSWORD</button>
    </div>
  </div>

  <div id="infoModal" class="fullscreen-overlay hidden">
    <div class="overlay-header"><h6 class="m-0 fw-bold">Panduan Aplikasi</h6><button class="btn-close-custom" onclick="closeInfoModal()"><i class="bi bi-x"></i></button></div>
    <div class="overlay-body">
        <ul class="nav nav-tabs mb-3" id="infoTabs">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabDaftar">Akun</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabInstall">Instalasi</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tabDaftar">
                <h6 class="fw-bold mb-3">Cara Klaim Nama / Daftar</h6>
                <div class="guide-step"><div class="step-num">1</div><div class="step-text">Klik <b>"Klaim Nama / Daftar Akun"</b> di halaman login.</div></div>
                <div class="guide-step"><div class="step-num">2</div><div class="step-text">Gunakan <b>Kotak Pencarian</b> untuk menemukan <b>Nama Lengkap</b> Anda.</div></div>
                <div class="guide-step"><div class="step-num">3</div><div class="step-text">Pilih <b>Asal AUM</b> yang sesuai.</div></div>
                <div class="guide-step"><div class="step-num">4</div><div class="step-text">Buat <b>Username</b> (Tanpa spasi) dan <b>Password</b>.</div></div>
            </div>
            <div class="tab-pane fade" id="tabInstall">
                <div class="alert alert-light border small">Instal aplikasi ini agar muncul di layar depan HP Anda.</div>
                <div class="mb-4"><span class="browser-badge bg-chrome">Android (Chrome)</span>
                    <div class="guide-step"><div class="step-num"><i class="bi bi-three-dots-vertical"></i></div><div class="step-text">Ketuk ikon titik tiga di pojok kanan atas browser.</div></div>
                    <div class="guide-step"><div class="step-num"><i class="bi bi-phone"></i></div><div class="step-text">Pilih menu <b>"Tambahkan ke Layar Utama"</b> (Add to Home Screen).</div></div>
                </div>
                <div class="mb-4"><span class="browser-badge bg-safari">iOS (Safari)</span>
                    <div class="guide-step"><div class="step-num"><i class="bi bi-box-arrow-up"></i></div><div class="step-text">Ketuk tombol <b>Share</b> (kotak dengan panah ke atas) di bagian bawah layar.</div></div>
                    <div class="guide-step"><div class="step-num"><i class="bi bi-plus-square"></i></div><div class="step-text">Geser ke bawah dan pilih <b>"Tambah ke Layar Utama"</b>.</div></div>
                </div>
            </div>
        </div>
    </div>
  </div>

</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzw2xX5TmEMzk_7mbXcoBCKlHauhbEgEcgdjApAxzaI3RY-8N9G5pT4LhV5XcrCbijaOQ/exec"; 
  const MAX_RADIUS = 500; 
  const DAFTAR_LOKASI = [
    { nama: "Masjid Abdul Aziz (SMP Muhammadiyah 8 Kebakkramat)", lat: -7.520470615403366, lng: 110.9065007512984 },
    { nama: "Gedung Dakwah PDM Karanganyar", lat: -7.586223863399417, lng: 110.91830297060768 },
    { nama: "Masjid Al Mukarromah, Karanganyar", lat: -7.5991158597467505, lng: 110.95277542273423 },
    { nama: "SMP Muhammadiyah 2 Karanganyar", lat: -7.59240065605104, lng: 110.95609234835774 },
    { nama: "Masjid Raya Al Falah Sragen", lat: -7.42851997638584, lng: 111.01776973992412 },
    { nama: "Kantor Desa Ngadiluwih, Matesih, Karanganyar", lat: -7.633272545502858, lng: 110.99996825526591 },
    { nama: "Lokasi Testing", lat: -7.716564379562363, lng: 110.59027731779902 },
    // LOKASI BARU
    { nama: "Catering Pandu", lat: -7.500030621538215, lng: 110.90614961162527 },
    { nama: "Hapsari Handayani", lat: -7.5137745006634935, lng: 110.912900811742 }
  ];

  var CURRENT_USER = null; 
  var LIST_NAMA_DB = []; var LIST_AUM_DB = []; // Global cache for search
  var video = document.getElementById('camera');
  var latUser=0, lngUser=0, lokasiString="", jarakUser=0, namaLokasiTerdekat="";
  var isAlreadyPresent=false, isTimeValid=false, isLocationValid=false;
  var gpsErrorMsg = "";

  window.onload = function() {
    checkSession(); 
    loadDbOptions(); 
    setInterval(validateButtonState, 1000);
  };

  // --- NEW FEATURES: TOGGLE & VALIDATION & SEARCH ---
  function togglePassword(inputId, icon) {
    var input = document.getElementById(inputId);
    if(input.type === "password") {
       input.type = "text"; icon.classList.replace("bi-eye-slash", "bi-eye"); icon.classList.add("active");
    } else {
       input.type = "password"; icon.classList.replace("bi-eye", "bi-eye-slash"); icon.classList.remove("active");
    }
  }

  function validateUsername(input) {
    // 1. Lowercase
    input.value = input.value.toLowerCase();
    // 2. Check Space
    var errorSpan = document.getElementById(input.id + 'Error');
    if(input.value.includes(" ")) {
       if(errorSpan) { errorSpan.classList.remove('hidden'); input.parentElement.classList.add('error'); }
    } else {
       if(errorSpan) { errorSpan.classList.add('hidden'); input.parentElement.classList.remove('error'); }
    }
  }

  function filterOptions(selectId, keyword) {
    var select = document.getElementById(selectId);
    var sourceData = (selectId === 'regNama') ? LIST_NAMA_DB : LIST_AUM_DB;
    
    // Clear and Rebuild
    select.innerHTML = `<option disabled selected>-- Pilih ${selectId==='regNama'?'Nama':'AUM'} --</option>`;
    
    var filtered = sourceData.filter(item => item.toLowerCase().includes(keyword.toLowerCase()));
    
    if(filtered.length === 0) {
        var opt = document.createElement('option'); opt.text = "Tidak ditemukan"; opt.disabled = true; select.add(opt);
    } else {
        filtered.forEach(item => {
            var opt = document.createElement('option'); opt.value = item; opt.text = item; select.add(opt);
        });
    }
  }

  function getNearestLocationName(lat, lng) {
    if(!lat || !lng) return "Lokasi Tidak Diketahui";
    var closestName = "Lokasi Tidak Diketahui";
    var minDist = Infinity;
    DAFTAR_LOKASI.forEach(loc => {
        var d = calcDist(lat, lng, loc.lat, loc.lng);
        if(d < minDist) { minDist = d; closestName = loc.nama; }
    });
    return closestName; 
  }

  // --- STANDARD FUNCTIONS ---
  function openInfoModal() { document.getElementById('infoModal').classList.remove('hidden'); }
  function closeInfoModal() { document.getElementById('infoModal').classList.add('hidden'); }

  async function openProfile() {
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getProfile', username: CURRENT_USER.username }) });
      let res = await req.json(); loading(false);
      if(res.status === 'success') {
        var d = res.data;
        document.getElementById('profNama').value = d.nama;
        var selAum = document.getElementById('profAum'); selAum.innerHTML = "";
        LIST_AUM_DB.forEach(a => { var opt = document.createElement('option'); opt.value = a; opt.text = a; if(a == d.aum) opt.selected = true; selAum.add(opt); });
        document.getElementById('profJk').value = d.jk; document.getElementById('profNbm').value = d.nbm;
        document.getElementById('profAlamat').value = d.alamat; document.getElementById('profTempat').value = d.tempat_lahir;
        document.getElementById('profTgl').value = d.tgl_lahir; document.getElementById('profEmail').value = d.email;
        document.getElementById('profHp').value = d.hp;
        document.getElementById('homeScreen').classList.add('hidden'); document.getElementById('profileScreen').classList.remove('hidden');
      } else { alert(res.message); }
    } catch(e) { loading(false); alert("Gagal: " + e); }
  }

  function closeProfile() { document.getElementById('profileScreen').classList.add('hidden'); document.getElementById('homeScreen').classList.remove('hidden'); }

  async function saveProfile() {
    var data = { username: CURRENT_USER.username, nama: document.getElementById('profNama').value, aum: document.getElementById('profAum').value, jk: document.getElementById('profJk').value, nbm: document.getElementById('profNbm').value, alamat: document.getElementById('profAlamat').value, tempat_lahir: document.getElementById('profTempat').value, tgl_lahir: document.getElementById('profTgl').value, email: document.getElementById('profEmail').value, hp: document.getElementById('profHp').value };
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateProfile', data: data }) });
      let res = await req.json(); loading(false); alert(res.message);
      if(res.status === 'success') {
         CURRENT_USER.nama = data.nama; CURRENT_USER.aum = data.aum;
         localStorage.setItem("PCM_USER", JSON.stringify(CURRENT_USER));
         document.getElementById('dashNama').innerText = data.nama; document.getElementById('dashAum').innerText = data.aum;
         closeProfile();
      }
    } catch(e) { loading(false); alert(e); }
  }

  function openChangePassword() { document.getElementById('homeScreen').classList.add('hidden'); document.getElementById('passwordScreen').classList.remove('hidden'); }
  function closeChangePassword() { document.getElementById('passwordScreen').classList.add('hidden'); document.getElementById('homeScreen').classList.remove('hidden'); }
  
  async function savePassword() {
    var p1 = document.getElementById('passNew').value; var p2 = document.getElementById('passConfirm').value;
    if(!p1 || p1 !== p2) return alert("Password tidak cocok / kosong");
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'changePassword', data: { username: CURRENT_USER.username, newPass: p1 } }) });
      let res = await req.json(); loading(false); alert(res.message); if(res.status === 'success') { closeChangePassword(); doLogout(); }
    } catch(e) { loading(false); alert(e); }
  }

  function validateButtonState() {
    if(!CURRENT_USER) return;
    var now = new Date(); var day = now.getDay(); var h = now.getHours(); var m = now.getMinutes(); var timeVal = h * 100 + m;
    if (day === 0 && timeVal >= 600 && timeVal <= 730) isTimeValid = true; else isTimeValid = false;
    // isTimeValid = true; // TESTING
    var btn = document.getElementById('btnStartAbsen'); var msg = document.getElementById('dashboardMsg');
    btn.classList.remove('btn-primary', 'btn-secondary'); btn.classList.remove('btn-danger'); msg.style.display = 'none'; msg.className = "";
    if (isAlreadyPresent) { btn.disabled = true; btn.innerHTML = "<i class='bi bi-check2-circle'></i> SUDAH PRESENSI"; btn.classList.add('btn-secondary'); }
    else if (!isTimeValid) { btn.disabled = true; btn.innerHTML = "<i class='bi bi-clock-history'></i> PRESENSI DITUTUP"; btn.classList.add('btn-secondary'); msg.innerHTML = "<b>Jadwal:</b> Ahad 06:00 - 07:30 WIB."; msg.style.display = 'block'; }
    else if (gpsErrorMsg !== "") { btn.disabled = true; btn.innerHTML = "<i class='bi bi-geo-alt'></i> AKTIFKAN GPS"; btn.classList.add('btn-secondary'); msg.innerHTML = `<i class="bi bi-exclamation-triangle"></i> <b>${gpsErrorMsg}</b><br>Mohon aktifkan lokasi.`; msg.style.display = 'block'; msg.classList.add('msg-danger'); }
    else if (latUser === 0 && lngUser === 0) { btn.disabled = true; btn.innerHTML = "<div class='spinner-border spinner-border-sm'></div> Mencari GPS..."; btn.classList.add('btn-secondary'); }
    else if (!isLocationValid) { btn.disabled = true; btn.innerHTML = "<i class='bi bi-geo-alt'></i> LOKASI TIDAK SESUAI"; btn.classList.add('btn-secondary'); msg.innerHTML = "<b>Anda jauh dari lokasi kajian.</b><br>Silakan mendekat."; msg.style.display = 'block'; }
    else { btn.disabled = false; btn.innerHTML = '<i class="bi bi-camera-fill"></i> PRESENSI SEKARANG'; btn.classList.add('btn-primary'); }
  }

  async function loadDashboardData() {
    var limit = document.getElementById('limitSelect').value;
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getReport', nama: CURRENT_USER.nama, limit: limit })});
      let res = await req.json();
      if(res.fotoTerbaru) { document.getElementById('dashFoto').src = "data:image/png;base64," + res.fotoTerbaru; document.getElementById('dashFoto').classList.remove('hidden'); document.getElementById('photoContainer').classList.add('hidden'); } 
      else { document.getElementById('photoContainer').innerHTML = "Belum Ada Foto"; }
      document.getElementById('dashLastDate').innerText = res.lastPresensi;
      if(res.stats) { document.getElementById('statCount').innerText = res.stats.userTotal + " / " + res.stats.globalTotal; document.getElementById('statPercent').innerText = res.stats.percent + "%"; }
      checkTodayStatus(res.history); renderHistory(res.history);
    } catch(e) {}
  }

  function checkTodayStatus(history) {
    var today = new Date(); isAlreadyPresent = false;
    if(history.length > 0) {
      var lastRaw = new Date(history[0].tanggalRaw);
      if(lastRaw.getDate() === today.getDate() && lastRaw.getMonth() === today.getMonth() && lastRaw.getFullYear() === today.getFullYear()) isAlreadyPresent = true;
    }
    validateButtonState();
  }

  function renderHistory(list) {
    var c = document.getElementById('historyList'); c.innerHTML = "";
    if(list.length === 0) { c.innerHTML = "<div class='text-center small text-muted'>Belum ada riwayat.</div>"; return; }
    list.forEach(i => { 
        var displayName = i.lokasi;
        var coordsMatch = i.lokasi.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
        if (coordsMatch && coordsMatch.length === 3) {
            displayName = getNearestLocationName(parseFloat(coordsMatch[1]), parseFloat(coordsMatch[2]));
        } else {
            if(displayName.includes('(')) displayName = displayName.split('(')[0].trim();
        }
        var html = `<div class="history-item"><div><div class="hist-date">${i.tanggal}</div><div class="hist-loc"><i class="bi bi-geo-alt-fill"></i> ${displayName}</div></div><div class="badge bg-light text-dark border">${i.jam}</div></div>`;
        c.innerHTML += html; 
    });
  }

  function formatTanggalIndoJS(d) {
    var h=["Ahad","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"]; var b=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    return h[d.getDay()] + ", " + d.getDate() + " " + b[d.getMonth()] + " " + d.getFullYear();
  }

  async function doLogin() {
    var u=document.getElementById('loginUser').value; var p=document.getElementById('loginPass').value;
    if(!u||!p) return alert("Isi data");
    if(u.includes(" ")) return alert("Username tidak boleh ada spasi");
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', data: { username: u, password: p } }) });
      let res = await req.json(); loading(false);
      if(res.status==='success') {
        CURRENT_USER = { username: res.username, nama: res.nama, aum: res.aum };
        localStorage.setItem("PCM_USER", JSON.stringify(CURRENT_USER)); showDashboard();
        if (navigator.geolocation) navigator.geolocation.watchPosition(updatePosisi, handleGpsError, {enableHighAccuracy:true});
      } else alert(res.message);
    } catch(e) { loading(false); alert(e); }
  }

  async function doRegister() {
    var n=document.getElementById('regNama').value; var a=document.getElementById('regAum').value; var u=document.getElementById('regUser').value; var p=document.getElementById('regPass').value;
    if(!n||!a||!u||!p) return alert("Lengkapi data");
    if(u.includes(" ")) return alert("Username tidak boleh ada spasi");
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'register', data: { username: u, password: p, nama: n, aum: a } }) });
      let res = await req.json(); loading(false); alert(res.message); if(res.status==='success') showLogin();
    } catch(e) { loading(false); alert(e); }
  }

  async function kirimAbsen() {
    var kes = document.getElementById('kesimpulan').value; if(!kes) return alert("Isi kesimpulan");
    loading(true);
    var cvs = document.getElementById('canvas'); cvs.width = video.videoWidth; cvs.height = video.videoHeight;
    var ctx = cvs.getContext('2d'); ctx.save(); ctx.translate(cvs.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0); ctx.restore();
    var d = new Date(); var dateStr = formatTanggalIndoJS(d); var timeStr = d.toLocaleTimeString('id-ID', {hour12:false})+" WIB";
    ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0, cvs.height - 80, cvs.width, 80);
    ctx.font = "bold 16px sans-serif"; ctx.fillStyle = "white"; 
    ctx.fillText(dateStr + " " + timeStr, 20, cvs.height - 50); ctx.fillText(namaLokasiTerdekat + " ("+jarakUser+"m)", 20, cvs.height - 25);
    var base64 = cvs.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/, "");
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'savePresensi', data: { nama: CURRENT_USER.nama, aum: CURRENT_USER.aum, kegiatan: "Pengajian - "+dateStr, kesimpulan: kes, lokasiString: lokasiString, lat: latUser, lng: lngUser, image: base64 } }) });
      let res = await req.json(); loading(false); alert(res.message); if(res.status==='success') { closePresensiMode(); loadDashboardData(); }
    } catch(e) { loading(false); alert(e); }
  }

  function checkSession() { var stored = localStorage.getItem("PCM_USER"); if (stored) { CURRENT_USER = JSON.parse(stored); showDashboard(); } else showLogin(); }
  function showLogin() { document.getElementById('authScreen').classList.remove('hidden'); document.getElementById('homeScreen').classList.add('hidden'); document.getElementById('formLogin').classList.remove('hidden'); document.getElementById('formRegister').classList.add('hidden'); }
  function showRegister() { document.getElementById('formLogin').classList.add('hidden'); document.getElementById('formRegister').classList.remove('hidden'); }
  
  function showDashboard() { 
    document.getElementById('authScreen').classList.add('hidden'); document.getElementById('homeScreen').classList.remove('hidden');
    document.getElementById('dashNama').innerText = CURRENT_USER.nama; document.getElementById('dashAum').innerText = CURRENT_USER.aum;
    loadDashboardData(); 
    if (navigator.geolocation) navigator.geolocation.watchPosition(updatePosisi, handleGpsError, {enableHighAccuracy:true});
  }
  
  function doLogout() { localStorage.removeItem("PCM_USER"); CURRENT_USER = null; showLogin(); }
  function openPresensiMode() { document.getElementById('homeScreen').classList.add('hidden'); document.getElementById('presensiScreen').classList.remove('hidden'); if(navigator.mediaDevices) navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(s=>video.srcObject=s); if(navigator.geolocation) navigator.geolocation.watchPosition(updatePosisi, handleGpsError, {enableHighAccuracy:true}); }
  function closePresensiMode() { if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop()); document.getElementById('presensiScreen').classList.add('hidden'); document.getElementById('homeScreen').classList.remove('hidden'); }
  
  async function loadDbOptions() {
    try {
       let r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getOptions' }) });
       let d = await r.json();
       if(d.status==='success') {
          LIST_NAMA_DB = d.nama; LIST_AUM_DB = d.aum; // Cache for search
          // Initial Load (Show First 10 maybe? Or empty until search)
          // We leave it empty until user searches for performance on mobile
       }
    } catch(e){}
  }

  function handleGpsError(err) {
    console.warn('GPS Error:', err.code);
    if(err.code == 1) gpsErrorMsg = "Izin Lokasi Ditolak.";
    else if(err.code == 2) gpsErrorMsg = "GPS Mati / Tidak Terdeteksi.";
    else if(err.code == 3) gpsErrorMsg = "Waktu Habis Mencari GPS.";
    else gpsErrorMsg = "Error GPS Tidak Diketahui.";
    isLocationValid = false; latUser = 0; lngUser = 0;
    validateButtonState();
  }

  function updatePosisi(pos) {
    gpsErrorMsg = ""; 
    latUser = pos.coords.latitude; lngUser = pos.coords.longitude; lokasiString = latUser+","+lngUser;
    
    var closest=Infinity, name="";
    DAFTAR_LOKASI.forEach(l => { var d=calcDist(latUser,lngUser,l.lat,l.lng); if(d<closest){closest=d;name=l.nama;} });
    jarakUser=Math.round(closest); namaLokasiTerdekat=name;
    isLocationValid = (jarakUser <= MAX_RADIUS);
    
    var statBox = document.getElementById('statusLokasiBox'); var btnKirim = document.getElementById('btnKirim');
    if(isLocationValid){ btnKirim.disabled=false; statBox.className = "alert alert-success py-2 small mb-3"; statBox.innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${name} (${jarakUser}m)`; } 
    else { btnKirim.disabled=true; statBox.className = "alert alert-danger py-2 small mb-3"; statBox.innerHTML = `<i class="bi bi-x-circle"></i> Kejauhan: ${jarakUser}m`; }
    
    validateButtonState();
  }
  function calcDist(lat1,lon1,lat2,lon2) { var R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180; var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
  function loading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }
</script>
</body>
</html>
