<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Presensi PCM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    :root { --primary: #0f766e; --bg: #f8fafc; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; -webkit-tap-highlight-color: transparent;}
    .app-container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; overflow-x: hidden; }
    
    /* LOGIN & GENERAL STYLES */
    #authScreen { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 200; background: white; padding: 30px; display: flex; flex-direction: column; justify-content: center; }
    .auth-logo { width: 80px; display: block; margin: 0 auto 20px; }
    .auth-title { text-align: center; font-weight: 700; color: var(--primary); margin-bottom: 30px; }
    .toggle-link { text-align: center; margin-top: 15px; font-size: 0.85rem; color: #64748b; cursor: pointer; text-decoration: underline; }
    .input-box { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 14px; padding: 12px; margin-bottom: 15px; }
    .form-control-plain { border: none; background: transparent; width: 100%; outline: none; }
    button.btn-primary { background: var(--primary); border: none; width: 100%; padding: 15px; border-radius: 15px; color: white; font-weight: 600; margin-top: 10px; }
    button.btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }

    /* DASHBOARD */
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary), #0d9488);
      padding: 25px 20px 80px; /* Padding bawah lebih besar untuk overlap */
      border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
      color: white; position: relative;
    }
    .user-info h5 { font-weight: 700; margin: 0; font-size: 1.2rem; }
    .user-info p { margin: 0; font-size: 0.85rem; opacity: 0.9; }
    .btn-logout { position: absolute; top: 25px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; }

    /* CARD FOTO & STATS */
    .main-card {
      background: white; margin: -60px 20px 20px; border-radius: 24px; padding: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.08); position: relative; z-index: 10;
    }
    
    /* Foto Besar Rounded */
    .photo-display { 
      width: 100%; aspect-ratio: 4/3; object-fit: cover; 
      border-radius: 16px; background: #f1f5f9; margin-bottom: 15px;
      display: block; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    .last-date-info { text-align: center; margin-bottom: 15px; }
    .last-date-info small { color: #64748b; font-size: 0.75rem; display: block; }
    .last-date-info strong { color: var(--primary); font-size: 0.9rem; }

    /* Stats Grid */
    .stats-grid { display: flex; gap: 10px; margin-bottom: 20px; }
    .stat-item { flex: 1; background: #f8fafc; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
    .stat-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 2px;}
    .stat-value { font-weight: 700; font-size: 1.1rem; color: #334155; }
    .stat-value.highlight { color: var(--primary); }

    .action-area { padding: 0 20px 20px; }
    #btnStartAbsen { width: 100%; padding: 16px; font-size: 1rem; border-radius: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 8px 20px rgba(15, 118, 110, 0.2); transition: 0.3s; }
    
    /* HISTORY */
    .history-section { padding: 0 20px 80px; }
    .section-title { font-weight: 700; font-size: 1rem; color: #334155; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .history-item { background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .hist-date { font-weight: 600; font-size: 0.85rem; color: #334155; }
    .hist-time { font-size: 0.75rem; color: #64748b; }
    .hist-loc { font-size: 0.7rem; color: #94a3b8; margin-top: 2px; }

    /* PRESENSI OVERLAY */
    #presensiScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 150; display: flex; flex-direction: column; }
    .presensi-header { padding: 15px 20px; display: flex; align-items: center; border-bottom: 1px solid #eee; }
    .btn-back { background: none; border: none; font-size: 1.5rem; color: #334155; margin-right: 15px; }
    .camera-container { width: 100%; aspect-ratio: 1; background: black; position: relative; overflow: hidden; }
    #camera { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .presensi-form { padding: 20px; flex-grow: 1; overflow-y: auto; }
    
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="loading" class="hidden"><div class="spinner-border text-success"></div><p class="mt-2 fw-bold text-success small">Memproses...</p></div>

<div class="app-container">

  <div id="authScreen">
    <img src="https://www.freepnglogos.com/uploads/logo-muhammadiyah-png/hq-free-logo-muhammadiyah-png-download-16.png" class="auth-logo">
    <h4 class="auth-title">Presensi PCM</h4>
    <div id="formLogin">
      <div class="input-box"><input type="text" id="loginUser" class="form-control-plain" placeholder="Username / Email"></div>
      <div class="input-box"><input type="password" id="loginPass" class="form-control-plain" placeholder="Password"></div>
      <button class="btn-primary" onclick="doLogin()">MASUK</button>
      <div class="toggle-link" onclick="showRegister()">Klaim Nama / Daftar Akun</div>
    </div>
    <div id="formRegister" class="hidden">
      <div class="alert alert-info py-2 small">Pilih Nama & AUM untuk membuat akun.</div>
      <div class="input-box"><select id="regNama" class="form-control-plain"><option disabled selected>-- Pilih Nama --</option></select></div>
      <div class="input-box"><select id="regAum" class="form-control-plain"><option disabled selected>-- Pilih AUM --</option></select></div>
      <div class="input-box"><input type="text" id="regUser" class="form-control-plain" placeholder="Username Baru"></div>
      <div class="input-box"><input type="password" id="regPass" class="form-control-plain" placeholder="Password Baru"></div>
      <button class="btn-primary" onclick="doRegister()">DAFTAR AKUN</button>
      <div class="toggle-link" onclick="showLogin()">Sudah punya akun? Login</div>
    </div>
  </div>

  <div id="homeScreen" class="hidden">
    <div class="dashboard-header">
      <div class="user-info">
        <h5 id="dashNama">Nama User</h5>
        <p id="dashAum">Asal AUM</p>
      </div>
      <button class="btn-logout" onclick="doLogout()">Keluar</button>
    </div>

    <div class="main-card">
      <img id="dashFoto" src="https://placehold.co/400x300?text=Belum+Ada+Foto" class="photo-display">
      
      <div class="last-date-info">
         <small>Terakhir Hadir:</small>
         <strong id="dashLastDate">-</strong>
      </div>

      <div class="stats-grid">
         <div class="stat-item">
            <span class="stat-label">Kehadiran</span>
            <span id="statCount" class="stat-value">0 / 0</span>
         </div>
         <div class="stat-item">
            <span class="stat-label">Persentase</span>
            <span id="statPercent" class="stat-value highlight">0%</span>
         </div>
      </div>
    </div>

    <div class="action-area">
      <button id="btnStartAbsen" class="btn-primary" onclick="openPresensiMode()">
        <i class="bi bi-camera-fill"></i> PRESENSI SEKARANG
      </button>
      <div id="todayStatus" class="text-center mt-2 small text-success fw-bold hidden">
         <i class="bi bi-check-circle-fill"></i> Anda sudah presensi hari ini
      </div>
    </div>

    <div class="history-section">
      <div class="section-title">
        <span>Riwayat Presensi</span>
        <select id="limitSelect" class="form-select form-select-sm" style="width: auto;" onchange="loadDashboardData()">
           <option value="10">10</option>
           <option value="25">25</option>
           <option value="50">50</option>
           <option value="100">100</option>
        </select>
      </div>
      <div id="historyList">
         <div class="text-center text-muted small py-3">Memuat data...</div>
      </div>
    </div>
  </div>

  <div id="presensiScreen" class="hidden">
    <div class="presensi-header">
      <button class="btn-back" onclick="closePresensiMode()"><i class="bi bi-arrow-left"></i></button>
      <h6 class="m-0 fw-bold">Form Presensi</h6>
    </div>
    <div class="camera-container">
       <video id="camera" autoplay playsinline></video>
    </div>
    <canvas id="canvas" class="hidden"></canvas>
    <div class="presensi-form">
      <div class="mb-3">
         <div id="statusLokasiBox" class="alert alert-warning py-2 small mb-2"><i class="bi bi-geo"></i> Mencari Lokasi...</div>
         <label class="form-label small fw-bold text-muted">Kesimpulan Kajian</label>
         <textarea id="kesimpulan" class="form-control" rows="3" placeholder="Tulis catatan..."></textarea>
      </div>
      <button id="btnKirim" class="btn-primary" onclick="kirimAbsen()" disabled>KIRIM DATA</button>
    </div>
  </div>

</div>

<script>
  // === KONFIGURASI ===
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyAmv2PI0Wz724kwEY7yMz6LQ6XAobcHhYgFOX5nhNSr5gMCQyVLIaDeEICDYiLjk-lJA/exec"; 
  const MAX_RADIUS = 500; 
  const DAFTAR_LOKASI = [
    { nama: "Masjid Abdul Aziz (SMPM 8)", lat: -7.520470615403366, lng: 110.9065007512984 },
    { nama: "Gedung Dakwah PDM", lat: -7.586223863399417, lng: 110.91830297060768 },
    { nama: "Masjid Al Mukarromah", lat: -7.5991158597467505, lng: 110.95277542273423 },
    { nama: "SMP Muhammadiyah 2 Kra", lat: -7.59240065605104, lng: 110.95609234835774 },
    { nama: "Masjid Raya Al Falah Sragen", lat: -7.42851997638584, lng: 111.01776973992412 },
    { nama: "Kantor Desa Ngadiluwih", lat: -7.633272545502858, lng: 110.99996825526591 },
    { nama: "Lokasi Testing", lat: -7.716564379562363, lng: 110.59027731779902 }
  ];

  var CURRENT_USER = null; 
  var video = document.getElementById('camera');
  var latUser=0, lngUser=0, lokasiString="", jarakUser=0, namaLokasiTerdekat="";

  window.onload = function() {
    checkSession(); 
    loadDbOptions(); 
  };

  function checkSession() {
    var stored = localStorage.getItem("PCM_USER");
    if (stored) {
      CURRENT_USER = JSON.parse(stored);
      showDashboard();
    } else {
      showLogin();
    }
  }

  function showLogin() {
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('homeScreen').classList.add('hidden');
    document.getElementById('presensiScreen').classList.add('hidden');
    document.getElementById('formLogin').classList.remove('hidden');
    document.getElementById('formRegister').classList.add('hidden');
  }

  function showRegister() {
    document.getElementById('formLogin').classList.add('hidden');
    document.getElementById('formRegister').classList.remove('hidden');
  }

  function showDashboard() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('presensiScreen').classList.add('hidden');
    document.getElementById('homeScreen').classList.remove('hidden');
    
    document.getElementById('dashNama').innerText = CURRENT_USER.nama.split(' ')[0];
    document.getElementById('dashAum').innerText = CURRENT_USER.aum;
    
    loadDashboardData();
  }

  function openPresensiMode() {
    document.getElementById('homeScreen').classList.add('hidden');
    document.getElementById('presensiScreen').classList.remove('hidden');
    startCamera();
    if (navigator.geolocation) {
       navigator.geolocation.watchPosition(updatePosisi, e => {}, { enableHighAccuracy: true });
    }
  }

  function closePresensiMode() {
    stopCamera();
    document.getElementById('presensiScreen').classList.add('hidden');
    document.getElementById('homeScreen').classList.remove('hidden');
  }

  function doLogout() {
    localStorage.removeItem("PCM_USER");
    CURRENT_USER = null;
    showLogin();
  }

  // === DATA LOADING & STATS ===
  async function loadDashboardData() {
    var limit = document.getElementById('limitSelect').value;
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ 
         action: 'getReport', 
         nama: CURRENT_USER.nama, 
         limit: limit 
      })});
      let res = await req.json();
      
      // 1. Update Foto
      if(res.fotoTerbaru) {
         document.getElementById('dashFoto').src = "data:image/png;base64," + res.fotoTerbaru;
      }

      // 2. Update Tanggal Terakhir (Bahasa Indo & Ahad)
      var lastDateText = res.lastPresensi.replace("Minggu", "Ahad");
      document.getElementById('dashLastDate').innerText = lastDateText;

      // 3. Update Statistik
      if(res.stats) {
         document.getElementById('statCount').innerText = res.stats.userTotal + " / " + res.stats.globalTotal;
         document.getElementById('statPercent').innerText = res.stats.percent + "%";
      }

      // 4. Cek Tombol Absen
      checkTodayStatus(res.history);

      // 5. Render History
      renderHistory(res.history);
      
    } catch(e) { console.log(e); }
  }

  function checkTodayStatus(history) {
    var today = new Date();
    var isPresent = false;
    
    if(history.length > 0) {
      // History index 0 adalah yang terbaru
      var lastRaw = new Date(history[0].tanggalRaw);
      if(lastRaw.getDate() === today.getDate() && 
         lastRaw.getMonth() === today.getMonth() && 
         lastRaw.getFullYear() === today.getFullYear()) {
         isPresent = true;
      }
    }

    var btn = document.getElementById('btnStartAbsen');
    var status = document.getElementById('todayStatus');

    if(isPresent) {
      btn.disabled = true;
      btn.innerHTML = "<i class='bi bi-check2-circle'></i> SUDAH PRESENSI";
      btn.classList.replace('btn-primary', 'btn-secondary'); // Ubah warna jadi abu
      btn.style.background = "#cbd5e1"; // Paksa warna
      status.classList.remove('hidden');
    } else {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-camera-fill"></i> PRESENSI SEKARANG';
      btn.style.background = "var(--primary)";
      status.classList.add('hidden');
    }
  }

  function renderHistory(list) {
    var container = document.getElementById('historyList');
    container.innerHTML = "";
    
    if(list.length === 0) {
       container.innerHTML = "<div class='text-center text-muted small py-3'>Belum ada riwayat.</div>";
       return;
    }

    list.forEach(item => {
       var tglIndo = item.tanggal.replace("Minggu", "Ahad");
       var html = `
       <div class="history-item">
          <div>
            <div class="hist-date">${tglIndo}</div>
            <div class="hist-loc"><i class="bi bi-geo-alt"></i> ${item.lokasi.split('(')[0].substring(0, 25)}...</div>
          </div>
          <div class="hist-time badge bg-light text-dark border">${item.jam}</div>
       </div>`;
       container.innerHTML += html;
    });
  }

  // === CORE & AUTH ===
  async function doLogin() {
    var u=document.getElementById('loginUser').value; var p=document.getElementById('loginPass').value;
    if(!u||!p) return alert("Isi data");
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', data: { username: u, password: p } }) });
      let res = await req.json(); loading(false);
      if(res.status==='success') {
        CURRENT_USER = { nama: res.nama, aum: res.aum };
        localStorage.setItem("PCM_USER", JSON.stringify(CURRENT_USER));
        showDashboard();
      } else alert(res.message);
    } catch(e) { loading(false); alert(e); }
  }

  async function doRegister() {
    var n=document.getElementById('regNama').value; var a=document.getElementById('regAum').value;
    var u=document.getElementById('regUser').value; var p=document.getElementById('regPass').value;
    if(!n||!a||!u||!p) return alert("Lengkapi data");
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'register', data: { username: u, password: p, nama: n, aum: a } }) });
      let res = await req.json(); loading(false);
      alert(res.message); if(res.status==='success') showLogin();
    } catch(e) { loading(false); alert(e); }
  }

  async function kirimAbsen() {
    var kes = document.getElementById('kesimpulan').value;
    if(!kes) return alert("Isi kesimpulan");
    loading(true);
    
    var cvs = document.getElementById('canvas');
    cvs.width = video.videoWidth; cvs.height = video.videoHeight;
    var ctx = cvs.getContext('2d');
    ctx.save(); ctx.translate(cvs.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0); ctx.restore();
    
    var now = new Date();
    var dateStr = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'}).replace("Minggu","Ahad");
    var timeStr = now.toLocaleTimeString('id-ID', {hour12:false}) + " WIB";
    
    ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0, cvs.height - 80, cvs.width, 80);
    ctx.font = "bold 16px sans-serif"; ctx.fillStyle = "white"; 
    ctx.fillText(dateStr + " " + timeStr, 20, cvs.height - 50);
    ctx.fillText(namaLokasiTerdekat + " ("+jarakUser+"m)", 20, cvs.height - 25);
    
    var base64 = cvs.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/, "");
    
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ 
          action: 'savePresensi', 
          data: { 
             nama: CURRENT_USER.nama, aum: CURRENT_USER.aum, 
             kegiatan: "Pengajian - " + dateStr, 
             kesimpulan: kes, lokasiString: lokasiString, lat: latUser, lng: lngUser, image: base64 
          } 
      })});
      let res = await req.json(); loading(false);
      alert(res.message);
      if(res.status==='success') {
         closePresensiMode();
         loadDashboardData(); 
      }
    } catch(e) { loading(false); alert(e); }
  }

  // === HELPERS ===
  function startCamera() {
    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s=>video.srcObject=s);
    }
  }
  function stopCamera() { if(video.srcObject) { video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; } }
  
  async function loadDbOptions() {
    try {
       let r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getOptions' }) });
       let d = await r.json();
       if(d.status==='success') {
          var s1 = document.getElementById('regNama'); s1.innerHTML='<option disabled selected>-- Pilih Nama --</option>';
          d.nama.forEach(n=>{ var o=document.createElement('option'); o.value=n; o.text=n; s1.add(o); });
          var s2 = document.getElementById('regAum'); s2.innerHTML='<option disabled selected>-- Pilih AUM --</option>';
          d.aum.forEach(a=>{ var o=document.createElement('option'); o.value=a; o.text=a; s2.add(o); });
       }
    } catch(e){}
  }

  function updatePosisi(pos) {
    latUser = pos.coords.latitude; lngUser = pos.coords.longitude; lokasiString = latUser+","+lngUser;
    var closest=Infinity, name="";
    DAFTAR_LOKASI.forEach(l => { var d=calcDist(latUser,lngUser,l.lat,l.lng); if(d<closest){closest=d;name=l.nama;} });
    jarakUser=Math.round(closest); namaLokasiTerdekat=name;
    
    var btn = document.getElementById('btnKirim');
    var stat = document.getElementById('statusLokasiBox');
    if(jarakUser<=MAX_RADIUS){ 
       btn.disabled=false; 
       stat.className = "alert alert-success py-2 small mb-2";
       stat.innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${name} (${jarakUser}m)`;
    } else { 
       btn.disabled=true; 
       stat.className = "alert alert-danger py-2 small mb-2";
       stat.innerHTML = `<i class="bi bi-x-circle"></i> Kejauhan: ${jarakUser}m`;
    }
  }
  
  function calcDist(lat1,lon1,lat2,lon2) {
    var R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
    var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
  function loading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }
</script>
</body>
</html>
