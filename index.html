<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Presensi PCM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    :root { --primary: #0f766e; --bg: #f8fafc; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; -webkit-tap-highlight-color: transparent;}
    .app-container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; overflow-x: hidden; }
    
    /* UTILITIES */
    .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; display: flex; flex-direction: column; overflow-y: auto; }
    .overlay-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; background: white; position: sticky; top:0; z-index:10;}
    .overlay-body { padding: 20px; flex-grow: 1; }
    .btn-close-custom { background: none; border: none; font-size: 1.5rem; color: #334155; }
    .hidden { display: none !important; }

    /* AUTH */
    #authScreen { z-index: 300; justify-content: center; } 
    .auth-logo { width: 80px; display: block; margin: 0 auto 20px; }
    .auth-title { text-align: center; font-weight: 700; color: var(--primary); margin-bottom: 30px; }
    .toggle-link { text-align: center; margin-top: 15px; font-size: 0.85rem; color: #64748b; cursor: pointer; text-decoration: underline; }
    
    /* INPUTS & BUTTONS */
    .input-box { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 14px; padding: 12px; margin-bottom: 15px; }
    .form-control-plain { border: none; background: transparent; width: 100%; outline: none; }
    .form-label { font-size: 0.75rem; font-weight: 600; color: #64748b; display: block; margin-bottom: 2px; }
    button.btn-primary { background: var(--primary); border: none; width: 100%; padding: 15px; border-radius: 15px; color: white; font-weight: 600; margin-top: 10px; }
    button.btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }

    /* DASHBOARD HEADER (REDESIGNED) */
    .dashboard-header { 
      background: linear-gradient(135deg, var(--primary), #0d9488); 
      padding: 20px 20px 80px; /* Extra padding bottom for overlap */
      border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; 
      color: white; position: relative; 
    }
    
    /* Header Top Row: Logo & Title */
    .header-top { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 20px; padding-right: 70px; /* Space for buttons */ }
    .header-logo-img { width: 45px; height: 45px; border-radius: 10px; background: rgba(255,255,255,0.2); padding: 5px; backdrop-filter: blur(5px); }
    .header-title h1 { font-size: 1.1rem; font-weight: 800; margin: 0; line-height: 1.2; letter-spacing: 0.5px; }
    .header-title p { font-size: 0.75rem; margin: 0; opacity: 0.85; font-weight: 400; }

    /* Header Actions (Top Right) */
    .header-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; }
    .btn-action-glass {
      background: rgba(255,255,255,0.2); border: none; color: white;
      width: 32px; height: 32px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(4px); font-size: 0.9rem; transition: 0.2s;
    }
    .btn-action-glass:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }

    /* User Info Row */
    .user-info-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 16px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
    .u-text h5 { margin: 0; font-size: 0.95rem; font-weight: 600; } /* Nama lebih kecil, tanpa garis bawah */
    .u-text p { margin: 0; font-size: 0.75rem; opacity: 0.8; }
    .btn-detail-profile { 
      background: white; color: var(--primary); border: none; 
      width: 30px; height: 30px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* MAIN CARD & STATS */
    .main-card { background: white; margin: -60px 20px 20px; border-radius: 24px; padding: 15px; box-shadow: 0 15px 30px rgba(0,0,0,0.08); position: relative; z-index: 10; }
    .photo-display { width: 100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 16px; background: #f1f5f9; margin-bottom: 15px; display: block; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .photo-loading { display: flex; align-items: center; justify-content: center; background: #e2e8f0; color: #64748b; font-size: 0.9rem; font-weight: 500; height: 200px; border-radius: 16px; margin-bottom: 15px;}
    
    .last-date-info { text-align: center; margin-bottom: 15px; }
    .last-date-info small { color: #64748b; font-size: 0.75rem; display: block; }
    .last-date-info strong { color: var(--primary); font-size: 0.9rem; }

    .stats-grid { display: flex; gap: 10px; margin-bottom: 20px; }
    .stat-item { flex: 1; background: #f8fafc; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
    .stat-value { font-weight: 700; font-size: 1.1rem; color: #334155; }
    .stat-value.highlight { color: var(--primary); }

    .action-area { padding: 0 20px 20px; }
    #btnStartAbsen { width: 100%; padding: 16px; font-size: 1rem; border-radius: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 8px 20px rgba(15, 118, 110, 0.2); transition: 0.3s; }
    
    #dashboardMsg { text-align: center; font-size: 0.8rem; margin-top: 10px; padding: 10px; border-radius: 10px; background: #fff3cd; color: #856404; display: none; border: 1px solid #ffeeba; }

    .history-section { padding: 0 20px 80px; }
    .history-item { background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .hist-date { font-weight: 600; font-size: 0.85rem; color: #334155; }
    
    .camera-container { width: 100%; aspect-ratio: 1; background: black; position: relative; overflow: hidden; border-radius: 16px; }
    #camera { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
  </style>
</head>
<body>

<div id="loading" class="hidden"><div class="spinner-border text-success"></div><p class="mt-2 fw-bold text-success small">Memproses...</p></div>

<div class="app-container">

  <div id="authScreen" class="fullscreen-overlay">
    <div style="padding: 30px; display: flex; flex-direction: column; justify-content: center; height: 100%;">
        <img src="https://www.freepnglogos.com/uploads/logo-muhammadiyah-png/hq-free-logo-muhammadiyah-png-download-16.png" class="auth-logo">
        <h4 class="auth-title">Presensi PCM</h4>
        
        <div id="formLogin">
          <div class="input-box"><input type="text" id="loginUser" class="form-control-plain" placeholder="Username / Email / No.HP"></div>
          <div class="input-box"><input type="password" id="loginPass" class="form-control-plain" placeholder="Password"></div>
          <button class="btn-primary" onclick="doLogin()">MASUK</button>
          <div class="toggle-link" onclick="showRegister()">Klaim Nama / Daftar Akun</div>
        </div>

        <div id="formRegister" class="hidden">
          <div class="alert alert-info py-2 small">Pilih Nama & AUM untuk membuat akun.</div>
          <div class="input-box"><select id="regNama" class="form-control-plain"><option disabled selected>-- Pilih Nama --</option></select></div>
          <div class="input-box"><select id="regAum" class="form-control-plain"><option disabled selected>-- Pilih AUM --</option></select></div>
          <div class="input-box"><input type="text" id="regUser" class="form-control-plain" placeholder="Username Baru"></div>
          <small class="text-muted" style="font-size:0.7rem; display:block; margin-top:-10px; margin-bottom:10px;">* Bisa No.HP atau Email</small>
          <div class="input-box"><input type="password" id="regPass" class="form-control-plain" placeholder="Password Baru"></div>
          <button class="btn-primary" onclick="doRegister()">DAFTAR AKUN</button>
          <div class="toggle-link" onclick="showLogin()">Sudah punya akun? Login</div>
        </div>
    </div>
  </div>

  <div id="homeScreen" class="hidden">
    <div class="dashboard-header">
      
      <div class="header-top">
        <img src="icon-512.png" class="header-logo-img" alt="Logo">
        <div class="header-title">
          <h1>Presensi Kajian AUM</h1>
          <p>PCM Kebakkramat, Karanganyar</p>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn-action-glass" onclick="openChangePassword()" title="Ganti Password">
          <i class="bi bi-key-fill"></i>
        </button>
        <button class="btn-action-glass" onclick="doLogout()" title="Keluar">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </div>

      <div class="user-info-row">
        <div class="u-text">
          <h5 id="dashNama">Nama User</h5>
          <p id="dashAum">Asal AUM</p>
        </div>
        <button class="btn-detail-profile" onclick="openProfile()" title="Lihat Detail Profil">
          <i class="bi bi-person-lines-fill"></i>
        </button>
      </div>

    </div>

    <div class="main-card">
      <div id="photoContainer" class="photo-loading">
         <span><div class="spinner-border spinner-border-sm text-secondary me-2"></div> Memuat Foto...</span>
      </div>
      <img id="dashFoto" class="photo-display hidden">
      
      <div class="text-center mb-3">
         <small class="text-muted">Terakhir Hadir:</small><br>
         <strong id="dashLastDate" class="text-primary">-</strong>
      </div>

      <div class="stats-grid">
         <div class="stat-item"><small class="text-muted">KEHADIRAN</small><div id="statCount" class="stat-value">0 / 0</div></div>
         <div class="stat-item"><small class="text-muted">PERSENTASE</small><div id="statPercent" class="stat-value highlight">0%</div></div>
      </div>
    </div>

    <div class="action-area">
      <button id="btnStartAbsen" class="btn-primary" onclick="openPresensiMode()" disabled><div class="spinner-border spinner-border-sm"></div> Memuat...</button>
      <div id="dashboardMsg"></div>
    </div>

    <div class="history-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="fw-bold">Riwayat</span>
        <select id="limitSelect" class="form-select form-select-sm w-auto" onchange="loadDashboardData()">
           <option value="10">10</option><option value="25">25</option><option value="50">50</option>
        </select>
      </div>
      <div id="historyList"><div class="text-center small text-muted">Memuat...</div></div>
    </div>
  </div>

  <div id="presensiScreen" class="fullscreen-overlay hidden">
    <div class="overlay-header">
      <h6 class="m-0 fw-bold">Form Presensi</h6>
      <button class="btn-close-custom" onclick="closePresensiMode()"><i class="bi bi-x"></i></button>
    </div>
    <div class="overlay-body">
        <div class="camera-container mb-3"><video id="camera" autoplay playsinline></video></div>
        <canvas id="canvas" class="hidden"></canvas>
        <div id="statusLokasiBox" class="alert alert-warning py-2 small mb-3">Mencari Lokasi...</div>
        <div class="input-box"><textarea id="kesimpulan" class="form-control-plain" rows="3" placeholder="Tulis kesimpulan kajian..."></textarea></div>
        <button id="btnKirim" class="btn-primary" onclick="kirimAbsen()" disabled>KIRIM DATA</button>
    </div>
  </div>

  <div id="profileScreen" class="fullscreen-overlay hidden">
    <div class="overlay-header">
      <h6 class="m-0 fw-bold">Profil Anggota</h6>
      <button class="btn-close-custom" onclick="closeProfile()"><i class="bi bi-arrow-left"></i></button>
    </div>
    <div class="overlay-body">
        <div class="alert alert-light border small mb-3">Lengkapi data diri Anda.</div>
        
        <label class="form-label">Nama Lengkap</label>
        <div class="input-box"><input type="text" id="profNama" class="form-control-plain"></div>
        <label class="form-label">Asal AUM</label>
        <div class="input-box"><select id="profAum" class="form-control-plain"></select></div>
        <label class="form-label">Jenis Kelamin</label>
        <div class="input-box">
            <select id="profJk" class="form-control-plain">
                <option value="">- Pilih -</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option>
            </select>
        </div>
        <label class="form-label">NBM</label>
        <div class="input-box"><input type="text" id="profNbm" class="form-control-plain"></div>
        <label class="form-label">Tempat Lahir</label>
        <div class="input-box"><input type="text" id="profTempat" class="form-control-plain"></div>
        <label class="form-label">Tanggal Lahir</label>
        <div class="input-box"><input type="date" id="profTgl" class="form-control-plain"></div>
        <label class="form-label">Alamat</label>
        <div class="input-box"><textarea id="profAlamat" class="form-control-plain" rows="2"></textarea></div>
        <label class="form-label">Email</label>
        <div class="input-box"><input type="email" id="profEmail" class="form-control-plain"></div>
        <label class="form-label">No HP</label>
        <div class="input-box"><input type="text" id="profHp" class="form-control-plain"></div>

        <button class="btn-primary" onclick="saveProfile()">SIMPAN PERUBAHAN</button>
    </div>
  </div>

  <div id="passwordScreen" class="fullscreen-overlay hidden">
    <div class="overlay-header">
      <h6 class="m-0 fw-bold">Ganti Password</h6>
      <button class="btn-close-custom" onclick="closeChangePassword()"><i class="bi bi-x"></i></button>
    </div>
    <div class="overlay-body">
        <div class="input-box"><input type="password" id="passNew" class="form-control-plain" placeholder="Password Baru"></div>
        <div class="input-box"><input type="password" id="passConfirm" class="form-control-plain" placeholder="Ulangi Password Baru"></div>
        <button class="btn-primary" onclick="savePassword()">UBAH PASSWORD</button>
    </div>
  </div>

</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwhguWqTSNaj04RRTi_5FjRd5mi6hKn4Sx1XuTdClIo5buq6-vkjHrIvXB6e5nfTdG13g/exec"; 
  const MAX_RADIUS = 500; 
  const DAFTAR_LOKASI = [
    { nama: "Masjid Abdul Aziz (SMP Muhammadiyah 8 Kebakkramat)", lat: -7.520470615403366, lng: 110.9065007512984 },
  { nama: "Gedung Dakwah PDM Karanganyar", lat: -7.586223863399417, lng: 110.91830297060768 },
  { nama: "Masjid Al Mukarromah, Karanganyar", lat: -7.5991158597467505, lng: 110.95277542273423 },
  { nama: "SMP Muhammadiyah 2 Karanganyar", lat: -7.59240065605104, lng: 110.95609234835774 },
  { nama: "Masjid Raya Al Falah Sragen", lat: -7.42851997638584, lng: 111.01776973992412 },
  { nama: "Kantor Desa Ngadiluwih, Matesih, Karanganyar", lat: -7.633272545502858, lng: 110.99996825526591 },
  { nama: "Lokasi Testing", lat: -7.716564379562363, lng: 110.59027731779902 }
  ];

  var CURRENT_USER = null; 
  var LIST_AUM_CACHE = [];
  var video = document.getElementById('camera');
  var latUser=0, lngUser=0, lokasiString="", jarakUser=0, namaLokasiTerdekat="";
  var isAlreadyPresent=false, isTimeValid=false, isLocationValid=false;

  window.onload = function() {
    checkSession(); 
    loadDbOptions(); 
    setInterval(validateButtonState, 1000);
  };

  // --- PROFILE & PASSWORD ---
  async function openProfile() {
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getProfile', username: CURRENT_USER.username }) });
      let res = await req.json();
      loading(false);
      
      if(res.status === 'success') {
        var d = res.data;
        document.getElementById('profNama').value = d.nama;
        var selAum = document.getElementById('profAum');
        selAum.innerHTML = "";
        LIST_AUM_CACHE.forEach(a => {
            var opt = document.createElement('option'); opt.value = a; opt.text = a;
            if(a == d.aum) opt.selected = true;
            selAum.add(opt);
        });
        document.getElementById('profJk').value = d.jk;
        document.getElementById('profNbm').value = d.nbm;
        document.getElementById('profAlamat').value = d.alamat;
        document.getElementById('profTempat').value = d.tempat_lahir;
        document.getElementById('profTgl').value = d.tgl_lahir;
        document.getElementById('profEmail').value = d.email;
        document.getElementById('profHp').value = d.hp;

        document.getElementById('homeScreen').classList.add('hidden');
        document.getElementById('profileScreen').classList.remove('hidden');
      } else { alert(res.message); }
    } catch(e) { loading(false); alert("Gagal: " + e); }
  }

  function closeProfile() {
    document.getElementById('profileScreen').classList.add('hidden');
    document.getElementById('homeScreen').classList.remove('hidden');
  }

  async function saveProfile() {
    var data = {
        username: CURRENT_USER.username,
        nama: document.getElementById('profNama').value,
        aum: document.getElementById('profAum').value,
        jk: document.getElementById('profJk').value,
        nbm: document.getElementById('profNbm').value,
        alamat: document.getElementById('profAlamat').value,
        tempat_lahir: document.getElementById('profTempat').value,
        tgl_lahir: document.getElementById('profTgl').value,
        email: document.getElementById('profEmail').value,
        hp: document.getElementById('profHp').value
    };
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateProfile', data: data }) });
      let res = await req.json();
      loading(false);
      alert(res.message);
      if(res.status === 'success') {
         CURRENT_USER.nama = data.nama;
         CURRENT_USER.aum = data.aum;
         localStorage.setItem("PCM_USER", JSON.stringify(CURRENT_USER));
         document.getElementById('dashNama').innerText = data.nama;
         document.getElementById('dashAum').innerText = data.aum;
         closeProfile();
      }
    } catch(e) { loading(false); alert(e); }
  }

  function openChangePassword() {
    document.getElementById('homeScreen').classList.add('hidden'); // Close Home
    document.getElementById('passwordScreen').classList.remove('hidden');
  }
  function closeChangePassword() {
    document.getElementById('passwordScreen').classList.add('hidden');
    document.getElementById('homeScreen').classList.remove('hidden'); // Back to Home
  }
  async function savePassword() {
    var p1 = document.getElementById('passNew').value;
    var p2 = document.getElementById('passConfirm').value;
    if(!p1 || p1 !== p2) return alert("Password tidak cocok / kosong");
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'changePassword', data: { username: CURRENT_USER.username, newPass: p1 } }) });
      let res = await req.json(); loading(false); alert(res.message);
      if(res.status === 'success') { closeChangePassword(); doLogout(); }
    } catch(e) { loading(false); alert(e); }
  }

  // --- CORE SYSTEM ---
  function validateButtonState() {
    if(!CURRENT_USER) return;
    var now = new Date();
    var day = now.getDay(); var h = now.getHours(); var m = now.getMinutes();
    var timeVal = h * 100 + m;
    
    // AHAD 06:00 - 07:30 (600 - 730)
    if (day === 0 && timeVal >= 600 && timeVal <= 730) isTimeValid = true;
    else isTimeValid = false;
    
    // isTimeValid = true; // TESTING

    var btn = document.getElementById('btnStartAbsen');
    var msg = document.getElementById('dashboardMsg');
    
    btn.classList.remove('btn-primary', 'btn-secondary');
    msg.style.display = 'none';

    if (isAlreadyPresent) {
        btn.disabled = true; btn.innerHTML = "<i class='bi bi-check2-circle'></i> SUDAH PRESENSI"; btn.classList.add('btn-secondary');
    } else if (!isTimeValid) {
        btn.disabled = true; btn.innerHTML = "<i class='bi bi-clock-history'></i> PRESENSI DITUTUP"; btn.classList.add('btn-secondary');
        msg.innerHTML = "<b>Jadwal:</b> Ahad 06:00 - 07:30 WIB."; msg.style.display = 'block';
    } else if (!isLocationValid) {
        btn.disabled = true; btn.innerHTML = "<i class='bi bi-geo-alt'></i> LOKASI TIDAK SESUAI"; btn.classList.add('btn-secondary');
        msg.innerHTML = "<b>Anda jauh dari lokasi kajian.</b>"; msg.style.display = 'block';
    } else {
        btn.disabled = false; btn.innerHTML = '<i class="bi bi-camera-fill"></i> PRESENSI SEKARANG'; btn.classList.add('btn-primary');
    }
  }

  async function loadDashboardData() {
    var limit = document.getElementById('limitSelect').value;
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getReport', nama: CURRENT_USER.nama, limit: limit })});
      let res = await req.json();
      
      if(res.fotoTerbaru) {
         document.getElementById('dashFoto').src = "data:image/png;base64," + res.fotoTerbaru;
         document.getElementById('dashFoto').classList.remove('hidden'); document.getElementById('photoContainer').classList.add('hidden');
      } else { document.getElementById('photoContainer').innerHTML = "Belum Ada Foto"; }

      document.getElementById('dashLastDate').innerText = res.lastPresensi;
      if(res.stats) {
         document.getElementById('statCount').innerText = res.stats.userTotal + " / " + res.stats.globalTotal;
         document.getElementById('statPercent').innerText = res.stats.percent + "%";
      }
      checkTodayStatus(res.history); renderHistory(res.history);
    } catch(e) {}
  }

  function checkTodayStatus(history) {
    var today = new Date(); isAlreadyPresent = false;
    if(history.length > 0) {
      var lastRaw = new Date(history[0].tanggalRaw);
      if(lastRaw.getDate() === today.getDate() && lastRaw.getMonth() === today.getMonth() && lastRaw.getFullYear() === today.getFullYear()) isAlreadyPresent = true;
    }
    validateButtonState();
  }

  function renderHistory(list) {
    var c = document.getElementById('historyList'); c.innerHTML = "";
    if(list.length === 0) { c.innerHTML = "<div class='text-center small text-muted'>Belum ada riwayat.</div>"; return; }
    list.forEach(i => {
       c.innerHTML += `<div class="history-item"><div><div class="hist-date">${i.tanggal}</div><div class="hist-loc"><i class="bi bi-geo-alt"></i> ${i.lokasi.split('(')[0].substring(0,25)}...</div></div><div class="badge bg-light text-dark border">${i.jam}</div></div>`;
    });
  }

  function formatTanggalIndoJS(d) {
    var h=["Ahad","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"]; var b=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    return h[d.getDay()] + ", " + d.getDate() + " " + b[d.getMonth()] + " " + d.getFullYear();
  }

  async function doLogin() {
    var u=document.getElementById('loginUser').value; var p=document.getElementById('loginPass').value;
    if(!u||!p) return alert("Isi data");
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', data: { username: u, password: p } }) });
      let res = await req.json(); loading(false);
      if(res.status==='success') {
        CURRENT_USER = { username: res.username, nama: res.nama, aum: res.aum };
        localStorage.setItem("PCM_USER", JSON.stringify(CURRENT_USER)); showDashboard();
        if (navigator.geolocation) navigator.geolocation.watchPosition(updatePosisi, e=>{}, {enableHighAccuracy:true});
      } else alert(res.message);
    } catch(e) { loading(false); alert(e); }
  }

  async function doRegister() {
    var n=document.getElementById('regNama').value; var a=document.getElementById('regAum').value; var u=document.getElementById('regUser').value; var p=document.getElementById('regPass').value;
    if(!n||!a||!u||!p) return alert("Lengkapi data");
    loading(true);
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'register', data: { username: u, password: p, nama: n, aum: a } }) });
      let res = await req.json(); loading(false); alert(res.message); if(res.status==='success') showLogin();
    } catch(e) { loading(false); alert(e); }
  }

  async function kirimAbsen() {
    var kes = document.getElementById('kesimpulan').value; if(!kes) return alert("Isi kesimpulan");
    loading(true);
    var cvs = document.getElementById('canvas'); cvs.width = video.videoWidth; cvs.height = video.videoHeight;
    var ctx = cvs.getContext('2d'); ctx.save(); ctx.translate(cvs.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0); ctx.restore();
    
    var d = new Date(); var dateStr = formatTanggalIndoJS(d); var timeStr = d.toLocaleTimeString('id-ID', {hour12:false})+" WIB";
    ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0, cvs.height - 80, cvs.width, 80);
    ctx.font = "bold 16px sans-serif"; ctx.fillStyle = "white"; 
    ctx.fillText(dateStr + " " + timeStr, 20, cvs.height - 50); ctx.fillText(namaLokasiTerdekat + " ("+jarakUser+"m)", 20, cvs.height - 25);
    var base64 = cvs.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/, "");
    
    try {
      let req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'savePresensi', data: { nama: CURRENT_USER.nama, aum: CURRENT_USER.aum, kegiatan: "Pengajian - "+dateStr, kesimpulan: kes, lokasiString: lokasiString, lat: latUser, lng: lngUser, image: base64 } }) });
      let res = await req.json(); loading(false); alert(res.message); if(res.status==='success') { closePresensiMode(); loadDashboardData(); }
    } catch(e) { loading(false); alert(e); }
  }

  function checkSession() {
    var stored = localStorage.getItem("PCM_USER");
    if (stored) { CURRENT_USER = JSON.parse(stored); showDashboard(); } else showLogin();
  }
  function showLogin() { 
    document.getElementById('authScreen').classList.remove('hidden'); document.getElementById('homeScreen').classList.add('hidden'); 
    document.getElementById('formLogin').classList.remove('hidden'); document.getElementById('formRegister').classList.add('hidden');
  }
  function showRegister() { document.getElementById('formLogin').classList.add('hidden'); document.getElementById('formRegister').classList.remove('hidden'); }
  function showDashboard() { 
    document.getElementById('authScreen').classList.add('hidden'); document.getElementById('homeScreen').classList.remove('hidden');
    document.getElementById('dashNama').innerText = CURRENT_USER.nama; document.getElementById('dashAum').innerText = CURRENT_USER.aum;
    loadDashboardData(); 
  }
  function doLogout() { localStorage.removeItem("PCM_USER"); CURRENT_USER = null; showLogin(); }
  function openPresensiMode() { 
    document.getElementById('homeScreen').classList.add('hidden'); document.getElementById('presensiScreen').classList.remove('hidden');
    if(navigator.mediaDevices) navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(s=>video.srcObject=s);
    if(navigator.geolocation) navigator.geolocation.watchPosition(updatePosisi, e=>{}, {enableHighAccuracy:true});
  }
  function closePresensiMode() { 
    if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
    document.getElementById('presensiScreen').classList.add('hidden'); document.getElementById('homeScreen').classList.remove('hidden'); 
  }
  
  async function loadDbOptions() {
    try {
       let r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getOptions' }) });
       let d = await r.json();
       if(d.status==='success') {
          LIST_AUM_CACHE = d.aum; // Simpan ke cache untuk profil
          var s1 = document.getElementById('regNama'); s1.innerHTML='<option disabled selected>-- Pilih Nama --</option>';
          d.nama.forEach(n=>{ var o=document.createElement('option'); o.value=n; o.text=n; s1.add(o); });
          var s2 = document.getElementById('regAum'); s2.innerHTML='<option disabled selected>-- Pilih AUM --</option>';
          d.aum.forEach(a=>{ var o=document.createElement('option'); o.value=a; o.text=a; s2.add(o); });
       }
    } catch(e){}
  }

  function updatePosisi(pos) {
    latUser = pos.coords.latitude; lngUser = pos.coords.longitude; lokasiString = latUser+","+lngUser;
    var closest=Infinity, name="";
    DAFTAR_LOKASI.forEach(l => { var d=calcDist(latUser,lngUser,l.lat,l.lng); if(d<closest){closest=d;name=l.nama;} });
    jarakUser=Math.round(closest); namaLokasiTerdekat=name;
    isLocationValid = (jarakUser <= MAX_RADIUS);
    
    var statBox = document.getElementById('statusLokasiBox');
    var btnKirim = document.getElementById('btnKirim');
    if(isLocationValid){ 
       btnKirim.disabled=false; statBox.className = "alert alert-success py-2 small mb-3"; statBox.innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${name} (${jarakUser}m)`;
    } else { 
       btnKirim.disabled=true; statBox.className = "alert alert-danger py-2 small mb-3"; statBox.innerHTML = `<i class="bi bi-x-circle"></i> Kejauhan: ${jarakUser}m`;
    }
    validateButtonState();
  }
  function calcDist(lat1,lon1,lat2,lon2) {
    var R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
    var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
  function loading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }
</script>
</body>
</html>
