<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Presensi PCM Kebakkramat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#198754">
  <link rel="apple-touch-icon" href="icon-192.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    /* ... (Copy CSS dari versi sebelumnya di sini) ... */
    body { padding: 15px; background-color: #f0f2f5; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
    .card-custom { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px; background: white; border-top: 5px solid #198754; }
    .hidden { display: none; }
    #camera { width: 100%; border-radius: 10px; background: #000; transform: scaleX(-1); }
    #canvas { display: none; }
  </style>
</head>
<body>

  <div class="container" style="max-width: 500px;">
    <div class="card-custom">
        <h5 class="text-center">Loading Sistem...</h5>
        </div>
  </div>

<script>
  // --- KONFIGURASI PWA ---
  // GANTI URL INI DENGAN URL DEPLOYMENT APPS SCRIPT ANDA
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZRX_Q8TmvnmvBeA2xi1bZLFNdhksm7rGuir-w7___iXjSYITwpsYd19jiFm8PsN3yLw/exec"; 

  // Register Service Worker (WAJIB UNTUK PWA)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js');
  }

  // --- FUNGSI KOMUNIKASI API (PENGGANTI google.script.run) ---
  
  // 1. Ambil Data Awal (Options)
  async function loadOptions() {
    try {
      let response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getOptions' })
      });
      let data = await response.json();
      if(data.status === 'success') {
         populateDropdown('nama', data.nama);
         populateDropdown('aum', data.aum);
         // Hapus loading, tampilkan form
         document.querySelector('h5').innerText = "Presensi Kajian AUM";
      }
    } catch (e) { alert("Gagal koneksi: " + e); }
  }

  // 2. Kirim Absen
  async function kirimAbsen() {
     // ... (Ambil nilai nama, aum, base64 image seperti sebelumnya) ...
     
     let payload = {
        action: 'savePresensi',
        data: {
           nama: namaVal, 
           aum: aumVal,
           image: base64Val,
           lat: latUser,
           lng: lngUser,
           // ... data lain
        }
     };

     document.getElementById('loading').classList.remove('hidden');

     try {
       let response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
       });
       let result = await response.json();
       
       alert(result.message);
       if(result.status === 'success') location.reload();
       
     } catch (e) {
       alert("Error Kirim: " + e);
     }
  }

  // 3. Load Report
  async function loadReportData() {
     // ... ambil value filter ...
     let payload = {
       action: 'getReport',
       nama: namaVal,
       start: startVal,
       end: endVal
     };
     
     let response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
     });
     let result = await response.json();
     
     // ... Render tabel seperti sebelumnya ...
  }

  window.onload = function() {
    loadOptions(); // Panggil data saat load
    // ... setup kamera & gps ...
  };

  // ... (Sisa fungsi helper seperti populateDropdown, GPS, dll copy dari versi lama) ...

</script>
</body>
</html>
