<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Presensi Kegiatan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --primary: #0f766e; --bg: #f8fafc; }
    body { font-family: sans-serif; background: var(--bg); padding-bottom: 80px; }
    .header-page { background: var(--primary); padding: 20px; color: white; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; display: flex; justify-content: space-between; align-items: center; }
    .event-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
    .event-card:active { transform: scale(0.98); border-color: var(--primary); background: #f0fdfa; }
    .camera-box { background:black; border-radius:15px; overflow:hidden; aspect-ratio:1; margin-bottom:15px; position: relative; }
    #camera { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; display:flex; align-items:center; justify-content:center;}
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-success"></div></div>

<div class="header-page">
    <h5 class="m-0 fw-bold">Pilih Kegiatan</h5>
    <a href="index.html" class="btn btn-sm btn-outline-light"><i class="bi bi-house-door-fill"></i> Home</a>
</div>

<div class="container mt-3">
    <div id="eventListContainer">
        </div>
</div>

<div id="modalCam" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:200; display:none; flex-direction:column;">
    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
        <h6 class="m-0 fw-bold" id="camTitle">Nama Event</h6>
        <button class="btn btn-sm btn-light" onclick="closeCam()"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="p-3 flex-grow-1 overflow-auto">
        <div class="camera-box"><video id="camera" autoplay playsinline></video></div>
        <canvas id="canvas" class="hidden"></canvas>
        <div id="gpsStatus" class="alert alert-warning py-2 small mb-3">Mencari GPS...</div>
        <input type="hidden" id="targetId">
        <input type="hidden" id="targetName">
        <button id="btnKirim" class="btn btn-primary w-100 py-3 fw-bold" onclick="kirimPresensi()" disabled>AMBIL FOTO & HADIR</button>
    </div>
</div>

<script>
    // --- PASTE SCRIPT URL ANDA DISINI ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwVCw1ZHhfTZAa4AzQh8slJOco8MQwCADz7bTiS1lPEKhVTUzRljSv9eG6zzyBrUx0D8Q/exec"; 

    var USER = JSON.parse(localStorage.getItem("PCM_USER"));
    var latUser=0, lngUser=0;

    window.onload = function() {
        if(!USER) window.location.href = "index.html";
        loadActiveEvents();
    };

    async function loadActiveEvents() {
        try {
            // Kirim data user agar backend bisa cek apakah dia sudah absen
            let res = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'getEvents', role: 'pengurus', user: USER }) 
            });
            let data = await res.json();
            document.getElementById('loading').classList.add('hidden');
            
            let html = '';
            if(data.data.length === 0) html = '<div class="text-center text-muted mt-5">Tidak ada kegiatan aktif.</div>';
            else {
                data.data.forEach(e => {
                    let btnHTML = '';
                    let cardClass = 'event-card';
                    let clickAction = `onclick="openCam('${e.id}', '${e.nama}')"`;

                    if (e.alreadyAttended) {
                        // SUDAH HADIR
                        btnHTML = `<span class="badge bg-secondary"><i class="bi bi-check-circle"></i> Sudah Hadir</span>`;
                        cardClass += ' bg-light text-muted border-success'; // Visual feedback
                        clickAction = ''; // Disable click
                    } else if (e.statusCode === 'future') {
                        // AKAN DATANG
                        btnHTML = `<span class="badge bg-info text-dark">Belum Dimulai</span>`;
                        clickAction = ''; // Disable click
                    } else if (e.statusCode === 'buka') {
                        // BUKA & BELUM HADIR
                        btnHTML = `<span class="badge bg-success">Presensi Sekarang</span>`;
                    } else {
                        // TUTUP (Fallback)
                        btnHTML = `<span class="badge bg-danger">Ditutup</span>`;
                        clickAction = '';
                    }

                    html += `
                    <div class="${cardClass}" ${clickAction}>
                        <div class="fw-bold text-dark">${e.nama}</div>
                        <div class="small text-muted"><i class="bi bi-calendar"></i> ${e.tanggal} | ${e.jam}</div>
                        <div class="small text-muted"><i class="bi bi-geo-alt"></i> ${e.lokasi}</div>
                        <div class="text-end mt-2">${btnHTML}</div>
                    </div>`;
                });
            }
            document.getElementById('eventListContainer').innerHTML = html;
        } catch(e) { alert("Gagal memuat data: " + e); }
    }

    function openCam(id, nama) {
        document.getElementById('targetId').value = id;
        document.getElementById('targetName').value = nama;
        document.getElementById('camTitle').innerText = nama;
        document.getElementById('modalCam').style.display = 'flex';
        
        navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(s => document.getElementById('camera').srcObject=s);
        navigator.geolocation.watchPosition(pos => {
            latUser = pos.coords.latitude; lngUser = pos.coords.longitude;
            document.getElementById('gpsStatus').className = 'alert alert-success py-2 small mb-3';
            document.getElementById('gpsStatus').innerHTML = '<i class="bi bi-geo-alt-fill"></i> Lokasi Terkunci';
            document.getElementById('btnKirim').disabled = false;
        }, err => {
            document.getElementById('gpsStatus').innerText = "GPS Error: Aktifkan Lokasi!";
        }, {enableHighAccuracy:true});
    }

    function closeCam() {
        document.getElementById('modalCam').style.display = 'none';
        let stream = document.getElementById('camera').srcObject;
        if(stream) stream.getTracks().forEach(t => t.stop());
    }

    async function kirimPresensi() {
        var video = document.getElementById('camera');
        var cvs = document.getElementById('canvas');
        cvs.width = video.videoWidth; cvs.height = video.videoHeight;
        var ctx = cvs.getContext('2d'); ctx.scale(-1,1); ctx.drawImage(video,0,0, -cvs.width, cvs.height);
        
        var base64 = cvs.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/, "");
        var eventId = document.getElementById('targetId').value;
        var eventName = document.getElementById('targetName').value;

        document.getElementById('loading').classList.remove('hidden');
        
        try {
            let res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'submitEventPresence',
                    data: {
                        eventId: eventId,
                        nama: USER.nama, aum: USER.aum,
                        lat: latUser, lng: lngUser, lokasiString: latUser+","+lngUser,
                        image: base64
                    }
                })
            });
            let r = await res.json();
            document.getElementById('loading').classList.add('hidden');
            alert(r.message);
            if(r.status === 'success') { closeCam(); window.location.href="index.html"; }
        } catch(e) {
            document.getElementById('loading').classList.add('hidden');
            alert("Error: " + e);
        }
    }
</script>
</body>
</html>
