<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kelola Jadwal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --primary: #1e40af; --bg: #eff6ff; } /* Nuansa Biru untuk Admin */
    body { font-family: sans-serif; background: var(--bg); padding-bottom: 80px; }
    .header-admin { background: var(--primary); padding: 20px; color: white; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; display: flex; justify-content: space-between; align-items: center; }
    .card-event { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; position: relative; }
    .btn-fab { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 1.8rem; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
    .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; display: none; flex-direction: column; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; display:flex; align-items:center; justify-content:center;}
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-primary"></div></div>

<div class="header-admin">
    <h5 class="m-0 fw-bold">Kelola Jadwal</h5>
    <a href="index.html" class="btn btn-sm btn-outline-light"><i class="bi bi-arrow-left"></i> Kembali</a>
</div>

<div class="container mt-4" id="eventList">
    </div>

<button class="btn-fab" onclick="openAddModal()"><i class="bi bi-plus"></i></button>

<div id="modalAdd" class="fullscreen-modal">
    <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
        <h6 class="m-0 fw-bold">Buat Kegiatan Baru</h6>
        <button class="btn btn-sm btn-secondary" onclick="closeAddModal()"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="p-4 overflow-auto">
        <div class="mb-3"><label class="small fw-bold">Nama Kegiatan</label><input type="text" id="evtNama" class="form-control"></div>
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="small fw-bold">Tanggal</label><input type="date" id="evtTgl" class="form-control"></div>
            <div class="col-3"><label class="small fw-bold">Mulai</label><input type="time" id="evtStart" class="form-control"></div>
            <div class="col-3"><label class="small fw-bold">Selesai</label><input type="time" id="evtEnd" class="form-control"></div>
        </div>
        <div class="mb-3"><label class="small fw-bold">Nama Lokasi</label><input type="text" id="evtLocName" class="form-control" placeholder="Cth: Gedung Dakwah"></div>
        <div class="mb-3"><label class="small fw-bold">Koordinat (Lat,Lng)</label><input type="text" id="evtCoord" class="form-control" placeholder="-7.xxx, 110.xxx">
        <small class="text-muted" style="font-size:0.75rem">Paste dari Google Maps</small></div>
        <div class="mb-3"><label class="small fw-bold">Radius (Meter)</label><input type="number" id="evtRad" class="form-control" value="100"></div>
        <button class="btn btn-primary w-100 py-2 fw-bold" onclick="saveEvent()">SIMPAN JADWAL</button>
    </div>
</div>

<script>
    // --- PASTE SCRIPT URL ANDA DISINI ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwVCw1ZHhfTZAa4AzQh8slJOco8MQwCADz7bTiS1lPEKhVTUzRljSv9eG6zzyBrUx0D8Q/exec"; 

    var USER = JSON.parse(localStorage.getItem("PCM_USER"));

    window.onload = function() {
        if(!USER || USER.role !== 'admin') {
            alert("Akses Admin Diperlukan!"); window.location.href = "index.html"; return;
        }
        loadEvents();
    };

    async function loadEvents() {
        try {
            let res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getEvents', role: 'admin' }) });
            let data = await res.json();
            document.getElementById('loading').classList.add('hidden');
            renderList(data.data);
        } catch(e) { alert("Gagal load: " + e); }
    }

    function renderList(list) {
        var html = '';
        if(list.length === 0) html = '<div class="text-center mt-5 text-muted">Belum ada jadwal kegiatan.</div>';
        
        list.forEach(item => {
            html += `
            <div class="card-event">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold text-dark fs-6">${item.nama}</div>
                        <div class="text-muted small mt-1"><i class="bi bi-calendar-event"></i> ${item.tanggal} | ${item.jam}</div>
                        <div class="text-muted small"><i class="bi bi-geo-alt"></i> ${item.lokasi}</div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${item.id}')"><i class="bi bi-trash"></i></button>
                </div>
            </div>`;
        });
        document.getElementById('eventList').innerHTML = html;
    }

    function openAddModal() { document.getElementById('modalAdd').style.display = 'flex'; }
    function closeAddModal() { document.getElementById('modalAdd').style.display = 'none'; }

    async function saveEvent() {
        var d = {
            nama: document.getElementById('evtNama').value,
            tanggal: document.getElementById('evtTgl').value,
            waktuMulai: document.getElementById('evtStart').value,
            waktuSelesai: document.getElementById('evtEnd').value,
            lokasiNama: document.getElementById('evtLocName').value,
            koordinat: document.getElementById('evtCoord').value,
            radius: document.getElementById('evtRad').value
        };
        if(!d.nama || !d.tanggal) return alert("Lengkapi data!");

        document.getElementById('loading').classList.remove('hidden');
        let res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'saveEvent', data: d }) });
        let r = await res.json();
        
        document.getElementById('loading').classList.add('hidden');
        alert(r.message);
        if(r.status==='success') { closeAddModal(); loadEvents(); }
    }

    async function deleteEvent(id) {
        if(!confirm("Hapus jadwal ini?")) return;
        document.getElementById('loading').classList.remove('hidden');
        let res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteEvent', id: id }) });
        let r = await res.json();
        document.getElementById('loading').classList.add('hidden');
        loadEvents();
    }
</script>
</body>
</html>
