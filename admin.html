<div id="modalForm" class="fullscreen-modal">
    <div class="modal-head">
        <h6 class="m-0 fw-bold" id="modalTitle">Buat Kegiatan Baru</h6>
        <button class="btn btn-sm btn-light" onclick="closeModal('modalForm')"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="modal-body-custom">
        <input type="hidden" id="evtId">
        
        <div class="mb-3"><label class="small fw-bold">Nama Kegiatan</label><input type="text" id="evtNama" class="form-control"></div>
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="small fw-bold">Tanggal</label><input type="date" id="evtTgl" class="form-control"></div>
            <div class="col-3"><label class="small fw-bold">Mulai</label><input type="time" id="evtStart" class="form-control"></div>
            <div class="col-3"><label class="small fw-bold">Selesai</label><input type="time" id="evtEnd" class="form-control"></div>
        </div>
        
        <div class="form-check form-switch bg-light p-3 rounded border mb-3">
            <input class="form-check-input" type="checkbox" id="evtManualClose">
            <label class="form-check-label fw-bold" for="evtManualClose">Tutup Presensi (Manual)</label>
            <div class="small text-muted" style="font-size:0.75rem">Centang ini jika ingin menutup presensi meskipun waktu belum habis.</div>
        </div>

        <div class="mb-3"><label class="small fw-bold">Nama Lokasi</label><input type="text" id="evtLocName" class="form-control" placeholder="Cth: Gedung Dakwah"></div>
        
        <div class="mb-3">
            <label class="small fw-bold d-flex justify-content-between">
                Koordinat (Lat,Lng) 
                <span class="text-primary" style="cursor:pointer" onclick="toggleTutorial()">Cara Isi? <i class="bi bi-info-circle"></i></span>
            </label>
            <input type="text" id="evtCoord" class="form-control" placeholder="-7.xxx, 110.xxx">
            <div id="boxTutorial" class="tutorial-box">
                <strong><i class="bi bi-laptop"></i> Via Laptop:</strong> Klik Kanan di Maps > Salin angka paling atas.<br>
                <strong><i class="bi bi-phone"></i> Via HP:</strong> Tekan tahan di peta > Muncul pin > Salin angka di bar pencarian.
            </div>
        </div>

        <div class="mb-3"><label class="small fw-bold">Radius (Meter)</label><input type="number" id="evtRad" class="form-control" value="100"></div>
        
        <button class="btn btn-primary w-100 mt-3" onclick="saveEvent()">SIMPAN DATA</button>
    </div>
</div>

<script>
    // ... (Script awal sama) ...

    function renderList(res) {
        var html = '';
        if(!res.data || res.data.length === 0) html = '<div class="text-center mt-5 text-muted">Tidak ada kegiatan.</div>';
        else {
            res.data.forEach(item => {
                // LOGIKA WARNA BADGE STATUS
                var badgeClass = 'bg-secondary';
                if(item.statusCode === 'buka') badgeClass = 'bg-success';
                else if(item.statusCode === 'future') badgeClass = 'bg-info text-dark';
                else badgeClass = 'bg-danger';

                html += `
                <div class="card-event">
                    <div class="d-flex justify-content-between">
                        <div class="event-title text-truncate" style="max-width:65%">${item.nama}</div>
                        <span class="status-badge ${badgeClass} text-white">${item.statusLabel}</span>
                    </div>
                    <div class="event-meta"><i class="bi bi-calendar"></i> ${item.tanggal}</div>
                    <div class="event-meta"><i class="bi bi-clock"></i> ${item.jam}</div>
                    <div class="event-meta"><i class="bi bi-geo-alt"></i> ${item.lokasi}</div>
                    
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-warning w-50" onclick="openEditModal('${item.id}')"><i class="bi bi-pencil"></i> Edit</button>
                        <button class="btn btn-sm btn-outline-danger w-50" onclick="deleteEvent('${item.id}')"><i class="bi bi-trash"></i> Hapus</button>
                    </div>
                </div>`;
            });
        }
        document.getElementById('eventList').innerHTML = html;
    }

    function openEditModal(id) {
        var item = cachedEvents.find(x => x.id === id);
        if(!item) return;

        document.getElementById('modalTitle').innerText = "Edit Kegiatan";
        document.getElementById('evtId').value = item.id;
        document.getElementById('evtNama').value = item.nama;
        document.getElementById('evtTgl').value = item.tglInput;
        document.getElementById('evtStart').value = item.waktuMulai;
        document.getElementById('evtEnd').value = item.waktuSelesai;
        document.getElementById('evtLocName').value = item.lokasi;
        document.getElementById('evtCoord').value = item.koordinat;
        document.getElementById('evtRad').value = item.radius;
        
        // SET STATUS CHECKBOX
        // Pastikan konversi string "TRUE" ke boolean true jika dari sheets
        var isClosed = (item.manualClose === true || item.manualClose === "TRUE" || item.manualClose === "true");
        document.getElementById('evtManualClose').checked = isClosed;

        document.getElementById('modalForm').style.display = 'flex';
    }

    async function saveEvent() {
        var d = {
            id: document.getElementById('evtId').value,
            nama: document.getElementById('evtNama').value,
            tanggal: document.getElementById('evtTgl').value,
            waktuMulai: document.getElementById('evtStart').value,
            waktuSelesai: document.getElementById('evtEnd').value,
            lokasiNama: document.getElementById('evtLocName').value,
            koordinat: document.getElementById('evtCoord').value,
            radius: document.getElementById('evtRad').value,
            manualClose: document.getElementById('evtManualClose').checked // Kirim Status Checkbox
        };
        // ... (sisanya sama seperti saveEvent sebelumnya)
    }
    
    // ... (fungsi lain sama)
</script>
