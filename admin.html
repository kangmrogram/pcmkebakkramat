<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin & Pengurus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --primary: #0f766e; --bg: #f8fafc; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); padding-bottom: 80px; }
    .header-admin { background: var(--primary); padding: 20px; color: white; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .card-event { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .event-title { font-weight: 700; font-size: 1rem; color: #334155; }
    .event-meta { font-size: 0.8rem; color: #64748b; display: flex; align-items: center; gap: 5px; margin-top: 5px; }
    .btn-fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(15, 118, 110, 0.4); border: none; z-index: 100; }
    
    /* MODAL FULLSCREEN */
    .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; display: none; flex-direction: column; }
    .modal-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-body-custom { padding: 20px; overflow-y: auto; flex-grow: 1; }
    
    .status-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; background: #d1fae5; color: #065f46; font-weight: 600; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; display:none; align-items:center; justify-content:center;}
  </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-success"></div></div>

<div class="header-admin">
    <div>
        <h5 class="m-0 fw-bold">Kegiatan PCM</h5>
        <small id="roleDisplay">Memuat role...</small>
    </div>
    <a href="index.html" class="text-white text-decoration-none border px-2 py-1 rounded small"><i class="bi bi-arrow-left"></i> Kembali</a>
</div>

<div class="container mt-3">
    <div id="eventList">
        <div class="text-center text-muted py-5">Memuat jadwal...</div>
    </div>
</div>

<button id="btnAddEvent" class="btn-fab" onclick="openAddModal()" style="display:none;"><i class="bi bi-plus"></i></button>

<div id="modalAdd" class="fullscreen-modal">
    <div class="modal-head"><h6 class="m-0 fw-bold">Buat Kegiatan Baru</h6><button class="btn btn-sm btn-light" onclick="closeModal('modalAdd')"><i class="bi bi-x-lg"></i></button></div>
    <div class="modal-body-custom">
        <div class="mb-3"><label class="small fw-bold">Nama Kegiatan</label><input type="text" id="evtNama" class="form-control"></div>
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="small fw-bold">Tanggal</label><input type="date" id="evtTgl" class="form-control"></div>
            <div class="col-3"><label class="small fw-bold">Mulai</label><input type="time" id="evtStart" class="form-control"></div>
            <div class="col-3"><label class="small fw-bold">Selesai</label><input type="time" id="evtEnd" class="form-control"></div>
        </div>
        <div class="mb-3"><label class="small fw-bold">Nama Lokasi</label><input type="text" id="evtLocName" class="form-control" placeholder="Cth: Gedung Dakwah"></div>
        <div class="mb-3"><label class="small fw-bold">Koordinat (Lat,Lng)</label><input type="text" id="evtCoord" class="form-control" placeholder="-7.xxx, 110.xxx">
        <small class="text-muted" style="font-size:0.7rem">Bisa diambil dari Google Maps.</small></div>
        <div class="mb-3"><label class="small fw-bold">Radius (Meter)</label><input type="number" id="evtRad" class="form-control" value="100"></div>
        <button class="btn btn-primary w-100 mt-3" onclick="saveEvent()">SIMPAN JADWAL</button>
    </div>
</div>

<div id="modalPresensi" class="fullscreen-modal">
    <div class="modal-head"><h6 class="m-0 fw-bold">Presensi Pengurus</h6><button class="btn btn-sm btn-light" onclick="closeModal('modalPresensi')"><i class="bi bi-x-lg"></i></button></div>
    <div class="modal-body-custom">
        <h5 id="presensiTitle" class="fw-bold mb-3">Nama Kegiatan</h5>
        <div style="background:black; border-radius:12px; overflow:hidden; aspect-ratio:1; margin-bottom:15px;">
            <video id="camera" autoplay playsinline style="width:100%; height:100%; object-fit:cover; transform:scaleX(-1);"></video>
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="gpsStatus" class="alert alert-warning py-1 small">Mencari Lokasi...</div>
        <input type="hidden" id="targetEventId">
        <button id="btnSubmitPresensi" class="btn btn-primary w-100" onclick="submitPresensi()" disabled>KIRIM PRESENSI</button>
    </div>
</div>

<script>
    // --- GANTI DENGAN URL DEPLOYMENT GOOGLE SCRIPT ANDA ---
    const SCRIPT_URL = "PASTE_URL_WEB_APP_EXEC_DISINI"; 

    var USER = JSON.parse(localStorage.getItem("PCM_USER"));
    var latUser=0, lngUser=0;

    window.onload = function() {
        if(!USER || (USER.role !== 'admin' && USER.role !== 'pengurus')) {
            alert("Akses ditolak!"); window.location.href = "index.html"; return;
        }
        document.getElementById('roleDisplay').innerText = "Mode: " + USER.role.toUpperCase();
        if(USER.role === 'admin') document.getElementById('btnAddEvent').style.display = 'flex';
        
        loadEvents();
    };

    // --- FUNGSI API FETCH (PENGGANTI google.script.run) ---
    async function apiCall(action, data = {}, id = null, role = null) {
        try {
            let body = { action: action };
            if(data) body.data = data;
            if(id) body.id = id;
            if(role) body.role = role;

            let response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(body)
            });
            return await response.json();
        } catch (e) {
            alert("Koneksi Error: " + e);
            return { status: 'error' };
        }
    }

    async function loadEvents() {
        let res = await apiCall('getEvents', null, null, USER.role);
        renderList(res);
    }

    function renderList(res) {
        var html = '';
        if(!res.data || res.data.length === 0) html = '<div class="text-center mt-5 text-muted">Tidak ada kegiatan aktif.</div>';
        else {
            res.data.forEach(item => {
                var btnAction = '';
                if(USER.role === 'admin') {
                    btnAction = `<button class="btn btn-sm btn-outline-danger mt-2" onclick="deleteEvent('${item.id}')"><i class="bi bi-trash"></i> Hapus</button>`;
                } else {
                    btnAction = `<button class="btn btn-sm btn-primary mt-2 w-100" onclick="openPresensi('${item.id}', '${item.nama}')"><i class="bi bi-camera-fill"></i> Hadir</button>`;
                }

                html += `
                <div class="card-event">
                    <div class="d-flex justify-content-between">
                        <div class="event-title">${item.nama}</div>
                        <span class="status-badge">${item.status}</span>
                    </div>
                    <div class="event-meta"><i class="bi bi-calendar"></i> ${item.tanggal}</div>
                    <div class="event-meta"><i class="bi bi-clock"></i> ${item.jam}</div>
                    <div class="event-meta"><i class="bi bi-geo-alt"></i> ${item.lokasi}</div>
                    ${btnAction}
                </div>`;
            });
        }
        document.getElementById('eventList').innerHTML = html;
    }

    // --- ADMIN FUNCTIONS ---
    function openAddModal() { document.getElementById('modalAdd').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    async function saveEvent() {
        var d = {
            nama: document.getElementById('evtNama').value,
            tanggal: document.getElementById('evtTgl').value,
            waktuMulai: document.getElementById('evtStart').value,
            waktuSelesai: document.getElementById('evtEnd').value,
            lokasiNama: document.getElementById('evtLocName').value,
            koordinat: document.getElementById('evtCoord').value,
            radius: document.getElementById('evtRad').value
        };
        if(!d.nama || !d.tanggal || !d.koordinat) return alert("Lengkapi data!");
        
        document.getElementById('loading').style.display = 'flex';
        let r = await apiCall('saveEvent', d);
        document.getElementById('loading').style.display = 'none';
        alert(r.message);
        if(r.status === 'success') { closeModal('modalAdd'); loadEvents(); }
    }

    async function deleteEvent(id) {
        if(!confirm("Hapus kegiatan ini?")) return;
        let r = await apiCall('deleteEvent', null, id);
        alert(r.message); loadEvents();
    }

    // --- PENGURUS FUNCTIONS ---
    function openPresensi(id, nama) {
        document.getElementById('targetEventId').value = id;
        document.getElementById('presensiTitle').innerText = nama;
        document.getElementById('modalPresensi').style.display = 'flex';
        
        if(navigator.mediaDevices) {
             navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(s => document.getElementById('camera').srcObject=s);
        }
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                latUser = pos.coords.latitude; lngUser = pos.coords.longitude;
                document.getElementById('gpsStatus').className = 'alert alert-success py-1 small';
                document.getElementById('gpsStatus').innerText = "Lokasi terkunci: " + latUser.toFixed(4);
                document.getElementById('btnSubmitPresensi').disabled = false;
            });
        }
    }

    async function submitPresensi() {
        var video = document.getElementById('camera');
        var cvs = document.getElementById('canvas');
        cvs.width = video.videoWidth; cvs.height = video.videoHeight;
        var ctx = cvs.getContext('2d'); ctx.scale(-1,1); ctx.drawImage(video,0,0, -cvs.width, cvs.height);
        var base64 = cvs.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/, "");
        
        var data = {
            eventId: document.getElementById('targetEventId').value,
            nama: USER.nama, aum: USER.aum,
            lat: latUser, lng: lngUser, lokasiString: latUser+","+lngUser,
            image: base64
        };

        document.getElementById('loading').style.display = 'flex';
        let r = await apiCall('submitEventPresence', data);
        document.getElementById('loading').style.display = 'none';
        alert(r.message);
        if(r.status === 'success') closeModal('modalPresensi');
    }
</script>

</body>
</html>
